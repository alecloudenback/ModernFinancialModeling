<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.9.16">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alec Loudenback">

<title>11&nbsp; Parallelization – Modern Financial Modeling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./computational-thinking.html" rel="next">
<link href="./performance-single.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-3ae586159be244f9b7da5612ca3882f5.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-4bdbedee417e7c90344270729bc2963b.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-3ae586159be244f9b7da5612ca3882f5.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6ee83196eee0eba8702f4dd364e0de5e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-860856505d205c70e29714261f4c7ddb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-6ee83196eee0eba8702f4dd364e0de5e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script data-goatcounter="https://julia-fin-book.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./conceptual-foundations2.html">Foundations: Building Performant Models</a></li><li class="breadcrumb-item"><a href="./parallelization.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Parallelization</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Modern Financial Modeling</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dedication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dedication</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./copyright.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Copyright</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./why-program.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Why Program?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./why-julia.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Why use Julia?</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./foundations-financial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundations: Effective Financial Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./elements-of-financial-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Elements of Financial Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./financial-modeling-practice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Practice of Financial Modeling</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./conceptual-foundations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundations: Programming and Abstractions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./foundations-of-programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Elements of Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./first-abstractions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Functional Abstractions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./type-abstractions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data and Types</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./patterns-abstraction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Higher Levels of Abstraction</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./conceptual-foundations2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundations: Building Performant Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hardware.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Hardware and Its Implications</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./performance-single.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Writing Performant Single-Threaded Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parallelization.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Parallelization</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./computational-thinking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interdisciplinary Concepts and Applications</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Applying Software Engineering Practices</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./elements-of-compsci.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Elements of Computer Science</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Statistical Inference and Information Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stochastic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Stochastic Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autodiff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Automatic Differentiation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Visualizations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matrices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Matrices and Their Uses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Learning from Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./julia-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Developing in Julia</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./julia-writing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Writing Julia Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./julia-debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Troubleshooting Julia Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./julia-sharing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Distributing and Sharing Julia Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./julia-optimizing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Optimizing Julia Code</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Applied Financial Modeling Techniques</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scenario-generation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Scenario Generation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./similarity-calculation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Similarity Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./portfolio-optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Portfolio Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sensitivity-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Sensitivity Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autodiff_alm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Automatic Differentiation for Asset Liability Management</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stochastic-mortality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Stochastic Mortality Projections</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayesian-mortality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Bayesian Mortality Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other-techniques.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">More Useful Techniques</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./appendices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ecosystem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">The Julia Ecosystem for Financial Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./book-index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Index</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#chapter-overview" id="toc-chapter-overview" class="nav-link active" data-scroll-target="#chapter-overview"><span class="header-section-number">11.1</span> Chapter Overview</a></li>
  <li><a href="#amdahls-law-and-the-limits-of-parallel-computing" id="toc-amdahls-law-and-the-limits-of-parallel-computing" class="nav-link" data-scroll-target="#amdahls-law-and-the-limits-of-parallel-computing"><span class="header-section-number">11.2</span> Amdahl’s Law and the Limits of Parallel Computing</a></li>
  <li><a href="#types-of-parallelism" id="toc-types-of-parallelism" class="nav-link" data-scroll-target="#types-of-parallelism"><span class="header-section-number">11.3</span> Types of Parallelism</a></li>
  <li><a href="#sec-vectorization" id="toc-sec-vectorization" class="nav-link" data-scroll-target="#sec-vectorization"><span class="header-section-number">11.4</span> Vectorization</a>
  <ul class="collapse">
  <li><a href="#hardware" id="toc-hardware" class="nav-link" data-scroll-target="#hardware"><span class="header-section-number">11.4.1</span> Hardware</a></li>
  </ul></li>
  <li><a href="#sec-multithreading" id="toc-sec-multithreading" class="nav-link" data-scroll-target="#sec-multithreading"><span class="header-section-number">11.5</span> Multi-Threading</a>
  <ul class="collapse">
  <li><a href="#sec-tasks" id="toc-sec-tasks" class="nav-link" data-scroll-target="#sec-tasks"><span class="header-section-number">11.5.1</span> Tasks</a></li>
  <li><a href="#multi-threading-overview" id="toc-multi-threading-overview" class="nav-link" data-scroll-target="#multi-threading-overview"><span class="header-section-number">11.5.2</span> Multi-Threading Overview</a></li>
  </ul></li>
  <li><a href="#sec-GPUs" id="toc-sec-GPUs" class="nav-link" data-scroll-target="#sec-GPUs"><span class="header-section-number">11.6</span> GPU and TPUs</a>
  <ul class="collapse">
  <li><a href="#hardware-1" id="toc-hardware-1" class="nav-link" data-scroll-target="#hardware-1"><span class="header-section-number">11.6.1</span> Hardware</a></li>
  <li><a href="#utilizing-a-gpu" id="toc-utilizing-a-gpu" class="nav-link" data-scroll-target="#utilizing-a-gpu"><span class="header-section-number">11.6.2</span> Utilizing a GPU</a></li>
  </ul></li>
  <li><a href="#sec-multi-device" id="toc-sec-multi-device" class="nav-link" data-scroll-target="#sec-multi-device"><span class="header-section-number">11.7</span> Multi-Processing / Multi-Device</a></li>
  <li><a href="#sec-parallel-programming-models" id="toc-sec-parallel-programming-models" class="nav-link" data-scroll-target="#sec-parallel-programming-models"><span class="header-section-number">11.8</span> Parallel Programming Models</a>
  <ul class="collapse">
  <li><a href="#map-reduce" id="toc-map-reduce" class="nav-link" data-scroll-target="#map-reduce"><span class="header-section-number">11.8.1</span> Map-Reduce</a></li>
  <li><a href="#array-based" id="toc-array-based" class="nav-link" data-scroll-target="#array-based"><span class="header-section-number">11.8.2</span> Array-Based</a></li>
  <li><a href="#loop-based" id="toc-loop-based" class="nav-link" data-scroll-target="#loop-based"><span class="header-section-number">11.8.3</span> Loop-Based</a></li>
  <li><a href="#task-based" id="toc-task-based" class="nav-link" data-scroll-target="#task-based"><span class="header-section-number">11.8.4</span> Task-Based</a></li>
  </ul></li>
  <li><a href="#choosing-a-parallelization-strategy" id="toc-choosing-a-parallelization-strategy" class="nav-link" data-scroll-target="#choosing-a-parallelization-strategy"><span class="header-section-number">11.9</span> Choosing a Parallelization Strategy</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">11.10</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./conceptual-foundations2.html">Foundations: Building Performant Models</a></li><li class="breadcrumb-item"><a href="./parallelization.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Parallelization</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-parallelization" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Parallelization</span></span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alec Loudenback </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>Quantity has a quality all its own. - Attributed to Vladimir Lenin</p>
</blockquote>
<section id="chapter-overview" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="chapter-overview"><span class="header-section-number">11.1</span> Chapter Overview</h2>
<p>Fundamentals of parallel workloads, different mechanisms to distribute work: vectorization (SIMD), multi-threading, GPU, and multi-device workflows. Different programming models: map-reduce, arrays, and tasks.</p>
</section>
<section id="amdahls-law-and-the-limits-of-parallel-computing" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="amdahls-law-and-the-limits-of-parallel-computing"><span class="header-section-number">11.2</span> Amdahl’s Law and the Limits of Parallel Computing</h2>
<p>An important ground truth in computing is that there is an upper limit to how fast a workload can be sped up through distributing the workload among multiple processor units. For example, if there is a modeling workload wherein 90% of the work is independent (say policy or asset level calculations) and the remaining 10% of the workload is an aggregate (say company or portfolio level), then the theoretical maximum speedup of the process is 10x faster (1 / 10% serial load). This is captured in a law known as <strong>Amdahl’s Law</strong>, and it reflects the <em>theoretical</em> maximum speedup a workload could see. In practice, the speedup is worse than this due to overhead of moving data around, scheduling the tasks, and aggregating results. This is why in many cases a good effort in sequential workloads (see <a href="performance-single.html" class="quarto-xref"><span>Chapter 10</span></a>) is often a more fruitful effort than trying to parallelize some workloads.</p>
<p>That said, there are still many modeling use-cases for parallelization. Modern investment and insurance portfolios can easily contain hundreds of thousands or millions of seriatim holdings. In many cases, these can be evaluated independently, though often there is interaction with the total portfolio (contract dividends, non-guaranteed elements, profit sharing, etc.). Further, even if the holdings are not parallelizable across the holdings dimension, we are often interested in independent evaluations across economic scenarios, which is amenable to parallelization.</p>
<p><span class="math display">\[
S(n) = \frac{1}{(1-p) + \frac{p}{n}}
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(S(n)\)</span> is the theoretical speedup of the execution of the whole task</li>
<li><span class="math inline">\(n\)</span> is the number of processors</li>
<li><span class="math inline">\(p\)</span> is the proportion of the execution time that benefits from improved resources</li>
</ul>
<p>We can visualize this for different combinations of <span class="math inline">\(p\)</span> and <span class="math inline">\(n\)</span> in <a href="#fig-amdahl" class="quarto-xref">Figure&nbsp;<span>11.1</span></a>.</p>
<div id="cell-fig-amdahl" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CairoMakie</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">amdahl_speedup</span>(p, n)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1</span> <span class="op">/</span> ((<span class="fl">1</span> <span class="op">-</span> p) <span class="op">+</span> p <span class="op">/</span> n)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span>()</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size<span class="op">=</span>(<span class="fl">800</span>, <span class="fl">600</span>))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Amdahl's Law"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        xlabel<span class="op">=</span>L<span class="st">"Number of processors (</span><span class="sc">$</span>n<span class="sc">$</span><span class="st">)",</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">        </span>ylabel<span class="st">="</span>Speedup<span class="st">",</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        xscale<span class="op">=</span>log2,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        xticks<span class="op">=</span><span class="fl">2</span> <span class="op">.^</span> (<span class="fl">0</span><span class="op">:</span><span class="fl">16</span>),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        xtickformat<span class="op">=</span>x <span class="op">-&gt;</span> <span class="st">"2^"</span> <span class="op">.*</span> <span class="fu">string</span>.(<span class="fu">Int</span>.(<span class="fu">log</span>.(<span class="fl">2</span>, x))),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        yticks<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="fl">2</span> <span class="op">.^</span> (<span class="fl">0</span><span class="op">:</span><span class="fl">16</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    parallel_portions <span class="op">=</span> [<span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    linestyles <span class="op">=</span> [<span class="op">:</span>solid, <span class="op">:</span>dash, <span class="op">:</span>dashdot, <span class="op">:</span>solid]</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, p) <span class="kw">in</span> <span class="fu">enumerate</span>(parallel_portions)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        speedup <span class="op">=</span> [<span class="fu">amdahl_speedup</span>(p, ni) for ni <span class="kw">in</span> n]</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines!</span>(ax, n, speedup, label<span class="op">=</span><span class="st">"</span><span class="sc">$</span>(<span class="fu">Int</span>(p<span class="op">*</span><span class="fl">100</span>))<span class="st">%"</span>, linestyle<span class="op">=</span>linestyles[i])</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlims!</span>(ax, <span class="fl">1</span>, <span class="fl">2</span><span class="op">^</span><span class="fl">16</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylims!</span>(ax, <span class="fl">0</span>, <span class="fl">20</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax, L<span class="st">"Parallel portion (</span><span class="sc">$</span>p<span class="sc">$</span><span class="st">)", </span>position<span class="st">=:lt)</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="fu">main</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-yellow-fg ansi-bold">┌ </span><span class="ansi-yellow-fg ansi-bold">Warning: </span>Found `resolution` in the theme when creating a `Scene`. The `resolution` keyword for `Scene`s and `Figure`s has been deprecated. Use `Figure(; size = ...` or `Scene(; size = ...)` instead, which better reflects that this is a unitless size and not a pixel resolution. The key could also come from `set_theme!` calls or related theming functions.

<span class="ansi-yellow-fg ansi-bold">└ </span><span class="ansi-bright-black-fg">@ Makie ~/.julia/packages/Makie/Vn16E/src/scenes.jl:264</span>
</pre>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div id="fig-amdahl" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-amdahl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="parallelization_files/figure-html/fig-amdahl-output-2.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-amdahl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.1: Theoretical upper bound for speedup of a workload given the parallelizable portion <span class="math inline">\(p\)</span> and number of processors <span class="math inline">\(n\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>A real-world analogy: imagine building a house. You can hire many workers to frame the walls, install plumbing, and run electrical wires simultaneously (the parallel part). However, all work must stop to wait for the single foundation to be poured and cured (the serial part). No matter how many workers you add, the total project time can never be faster than the time it takes to cure the foundation. This fundamental bottleneck is what Amdahl’s Law describes.</p>
<p>With this understanding, we will be able to set expectations and analyze the benefit of parallelization.</p>
</section>
<section id="types-of-parallelism" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="types-of-parallelism"><span class="header-section-number">11.3</span> Types of Parallelism</h2>
<p>Parallel processing comes in different flavors and is related to the details of hardware as discussed in <a href="hardware.html" class="quarto-xref"><span>Chapter 9</span></a>. We will necessarily extend the discussion of hardware here, as parallelization is (mostly) inextricably tied to hardware details. We revisit this in <a href="#sec-parallel-programming-models" class="quarto-xref"><span>Section 11.8</span></a> when we connect the techniques back to programming abstractions and real models.</p>
<table class="caption-top table">
<caption>Major types of computational parallelism highlighting their key characteristics, advantages, and potential drawbacks.</caption>
<colgroup>
<col style="width: 24%">
<col style="width: 26%">
<col style="width: 24%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Type</th>
<th>Description</th>
<th>Strengths</th>
<th>Weaknesses</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Vectorization (SIMD)</td>
<td>Performs same operation on multiple data points simultaneously</td>
<td>Efficient for data-parallel tasks, uses specialized CPU instructions</td>
<td>Limited to certain types of operations, data must be contiguous</td>
</tr>
<tr class="even">
<td>Multi-Threading</td>
<td>Executes multiple threads concurrently on a single CPU</td>
<td>Good for task parallelism, utilizes multi-core processors effectively</td>
<td>Overhead from thread management, potential race conditions</td>
</tr>
<tr class="odd">
<td>GPU</td>
<td>Uses graphics processing units (GPUs) for parallel computations</td>
<td>Excellent for massively parallel tasks, high throughput</td>
<td>Specialized programming required, data transfer overhead</td>
</tr>
<tr class="even">
<td>Multi-Device / Distributed</td>
<td>Spreads computation across multiple machines or devices</td>
<td>Scales to very large problems, can use heterogeneous hardware</td>
<td>Complex to implement and manage, network latency issues</td>
</tr>
</tbody>
</table>
</section>
<section id="sec-vectorization" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="sec-vectorization"><span class="header-section-number">11.4</span> Vectorization</h2>
<p><strong>Vectorization</strong> in the context of parallel processing refers to special circuits within the CPU wherein the CPU will load multiple data units (e.g.&nbsp;4 or 8 floating point numbers) in a contiguous block and perform the same instruction on them at the same time. This is also known as <strong>SIMD, or Single-Instruction Multiple Data</strong>. Think of it like a <code>for</code> loop where each iteration does four or eight operations at a time instead of one.</p>
<p>The requirements for SIMD-able code are that:</p>
<ul>
<li>The intended section for SIMD is inside the inner-most loop.</li>
<li>There are no branches (if-statements) inside the loop body.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that indexing an array is actually a branch in the code, as two cases could arise: the index is either inbounds or out-of-bounds. To avoid this, either use <code>for x in collection</code>, <code>for i in eachindex(collection)</code> or <code>for i in 1:n; @inbounds collection[i]</code>, though the last of these is discouraged in favor of the prior, safer options.</p>
</div>
</div>
<div id="13e2db54" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">prevent_simd</span>(arr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    sum <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> arr</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            sum <span class="op">+=</span> x</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sum</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">allow_simd</span>(arr)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    sum <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> arr</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        sum <span class="op">+=</span> <span class="fu">max</span>(x, <span class="fl">0</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sum</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">10000</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@btime</span> <span class="fu">prevent_simd</span>(<span class="op">$</span>x)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@btime</span> <span class="fu">allow_simd</span>(<span class="op">$</span>x)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  44.208 μs (0 allocations: 0 bytes)
  4.821 μs (0 allocations: 0 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>5008.624522856255</code></pre>
</div>
</div>
<p>In testing the above code, the <code>allow_simd</code> version should be several times faster than the <code>prevent_simd</code> example. The reason is that <code>prevent_simd</code> has a branch (<code>if x &gt; 0</code>) where the behavior of the code may change depending on the value in <code>arr</code>. Conversely, the behavior of <code>allow_simd</code> is always the same in each iteration, no matter the value of <code>x</code>. This allows the compiler to generate vectorized code automatically.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that Julia’s compiler is able to identify vectorizable code in many cases, though some cases may benefit from a more manual hint to the compiler through macro annotations (enter <code>?@simd</code> in the REPL for details). See <a href="julia-optimizing.html#sec-optimizing-SIMD" class="quarto-xref"><span>Section 24.9.4</span></a> for more.</p>
</div>
</div>
<p>Other types of parallelism that we will discuss in this chapter have some risk of errors or data corruption if not used correctly. SIMD isn’t prone to issues like this because if the code is not SIMD-able then the compiler will not auto-vectorize the code block.</p>
<section id="hardware" class="level3" data-number="11.4.1">
<h3 data-number="11.4.1" class="anchored" data-anchor-id="hardware"><span class="header-section-number">11.4.1</span> Hardware</h3>
<p>Vectorization is hardware dependent. If the CPU does not support vectorization you will not see speedups from it. Many consumer and professional chips have AVX2 (Advanced Vector Extensions 2), which uses 256-bit registers allowing four simultaneous 64-bit floating-point operations. AVX-512, with 512-bit registers (eight simultaneous 64-bit operations), is common on Intel server chips and recent AMD processors. However, AVX-512 can cause thermal throttling on some chips—wider SIMD uses more power and generates more heat—so real-world speedups depend on sustained workloads and cooling.</p>
<p>On ARM processors (AArch64), the equivalent is NEON (128-bit, two 64-bit operations) and the newer SVE/SVE2 (Scalable Vector Extension) which supports variable-width vectors up to 2048 bits. Apple’s M-series chips use NEON; ARM server chips like AWS Graviton3 support SVE.</p>
</section>
</section>
<section id="sec-multithreading" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="sec-multithreading"><span class="header-section-number">11.5</span> Multi-Threading</h2>
<p>This subsection starts by introducing <em>tasks</em> - lightweight units of computation. Next, we will see how tasks can communicate using <em>channels</em>, and then how multiple tasks (and channels) can be leveraged to achieve true parallelism through <em>multi-threading</em>. Think of it as layers building on one another: tasks define work units, channels allow them to share data, and multi-threading enables tasks to run simultaneously on multiple CPU cores. Exact details regarding tasks, channels, and multi-threading vary by language but the general ideas remain the same.</p>
<section id="sec-tasks" class="level3" data-number="11.5.1">
<h3 data-number="11.5.1" class="anchored" data-anchor-id="sec-tasks"><span class="header-section-number">11.5.1</span> Tasks</h3>
<p>To understand multi-threading examples, we first need to discuss <strong>Tasks</strong>, which are chunks of computation that get performed together, but after which the computer is free to switch to a new task. Technically, there are some instructions within a task that will let the computer pause and come back to that task later (such as <code>sleep</code>).</p>
<p>Tasks do not, by themselves, allow for multiple computations to be performed in parallel. For example, one task might be loading a data file from persistent storage into RAM. After that task is complete, the computer continues on with another task in the queue (rendering a web page, playing a song, etc.). In this way even a single processor computer could be “doing multiple things at once” (or “multi-tasking”) even though nothing is running in parallel. The scheduling of the tasks is handled automatically by the program’s compiler or the operating system.</p>
<p>Here’s an example of a couple of tasks where we write to an array. Despite being called last, the second task should actually write to the array before the first task. This is because we asked the first task to <code>sleep</code> (pause, while allowing the computer to yield to other tasks in the queue)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div id="6f65c158" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    shared_array <span class="op">=</span> <span class="fu">zeros</span>(<span class="fl">5</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    task1 <span class="op">=</span> <span class="pp">@task</span> <span class="cf">begin</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sleep</span>(<span class="fl">1</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        shared_array[<span class="fl">1</span>] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(<span class="st">"Task 1: "</span>, shared_array)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    task2 <span class="op">=</span> <span class="pp">@task</span> <span class="cf">begin</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        shared_array[<span class="fl">2</span>] <span class="op">=</span> <span class="fl">2</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(<span class="st">"Task 2: "</span>, shared_array)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">schedule</span>(task1)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">schedule</span>(task2)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wait</span>(task1)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wait</span>(task2)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Main: "</span>, shared_array)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Task 2: [0.0, 2.0, 0.0, 0.0, 0.0]
Task 1: [1.0, 2.0, 0.0, 0.0, 0.0]
Main: [1.0, 2.0, 0.0, 0.0, 0.0]</code></pre>
</div>
</div>
<section id="sec-channels" class="level4" data-number="11.5.1.1">
<h4 data-number="11.5.1.1" class="anchored" data-anchor-id="sec-channels"><span class="header-section-number">11.5.1.1</span> Channels</h4>
<p><strong>Channels</strong> are a way to communicate data in a managed way between tasks. You specify a type of data that the buffer (a chunk of assigned memory) will contain and how many elements it can hold. It then stores items (via <code>put!</code>) in a first-in-first-out (FIFO) queue, which can be popped off the queue (via <code>take!</code>) by other tasks.</p>
<p>Here’s an example of a system which generates trades in the financial markets at random time intervals, and a monitoring task takes the results and tabulates running statistics:</p>
<div id="55d22a50" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># simulate random trades and the associated profits </span></span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">trade_producer</span>(channel, i)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-4-5" class="code-annotation-target"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sleep</span>(<span class="fu">rand</span>())</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-4-6" class="code-annotation-target"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> <span class="fu">randn</span>()</span>
<span id="annotated-cell-4-7"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">put!</span>(channel, profit)</span>
<span id="annotated-cell-4-8"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(<span class="st">"Producer: Trade Result #</span><span class="sc">$</span>i<span class="st"> </span><span class="sc">$</span>(<span class="fu">round</span>(profit, digits<span class="op">=</span><span class="fl">3</span>))<span class="st">"</span>)</span>
<span id="annotated-cell-4-9"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-4-10"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-11"><a href="#annotated-cell-4-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intake trades via the communication channel</span></span>
<span id="annotated-cell-4-12"><a href="#annotated-cell-4-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">portfolio_monitor</span>(channel, n)</span>
<span id="annotated-cell-4-13"><a href="#annotated-cell-4-13" aria-hidden="true" tabindex="-1"></a>        sum <span class="op">=</span> <span class="fl">0.0</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-4-14" class="code-annotation-target"><a href="#annotated-cell-4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="annotated-cell-4-15"><a href="#annotated-cell-4-15" aria-hidden="true" tabindex="-1"></a>            profit <span class="op">=</span> <span class="fu">take!</span>(channel)</span>
<span id="annotated-cell-4-16"><a href="#annotated-cell-4-16" aria-hidden="true" tabindex="-1"></a>            sum <span class="op">+=</span> profit</span>
<span id="annotated-cell-4-17"><a href="#annotated-cell-4-17" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> <span class="fu">round</span>(profit, digits<span class="op">=</span><span class="fl">3</span>)</span>
<span id="annotated-cell-4-18"><a href="#annotated-cell-4-18" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> <span class="fu">round</span>(sum, digits<span class="op">=</span><span class="fl">3</span>)</span>
<span id="annotated-cell-4-19"><a href="#annotated-cell-4-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">println</span>(<span class="st">"Monitor: Received </span><span class="sc">$</span>p<span class="st">, Cumulative: </span><span class="sc">$</span>s<span class="st">"</span>)</span>
<span id="annotated-cell-4-20"><a href="#annotated-cell-4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-4-21"><a href="#annotated-cell-4-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-4-22"><a href="#annotated-cell-4-22" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-4-23" class="code-annotation-target"><a href="#annotated-cell-4-23" aria-hidden="true" tabindex="-1"></a>    channel <span class="op">=</span> <span class="fu">Channel</span><span class="dt">{Float64}</span>(<span class="fl">32</span>)</span>
<span id="annotated-cell-4-24"><a href="#annotated-cell-4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-25"><a href="#annotated-cell-4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start producer and consumer tasks</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-4-26" class="code-annotation-target"><a href="#annotated-cell-4-26" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">begin</span></span>
<span id="annotated-cell-4-27"><a href="#annotated-cell-4-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span id="annotated-cell-4-28"><a href="#annotated-cell-4-28" aria-hidden="true" tabindex="-1"></a>            <span class="pp">@async</span> <span class="fu">trade_producer</span>(channel, i)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-4-29" class="code-annotation-target"><a href="#annotated-cell-4-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-4-30"><a href="#annotated-cell-4-30" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@async</span> <span class="fu">portfolio_monitor</span>(channel, <span class="fl">5</span>)</span>
<span id="annotated-cell-4-31"><a href="#annotated-cell-4-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-4-32"><a href="#annotated-cell-4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-33"><a href="#annotated-cell-4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-34"><a href="#annotated-cell-4-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Close the channel and wait for tasks to finish</span></span>
<span id="annotated-cell-4-35"><a href="#annotated-cell-4-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">close</span>(channel)</span>
<span id="annotated-cell-4-36"><a href="#annotated-cell-4-36" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="5" data-code-annotation="1">Random sleep between 0 and 1 seconds to simulate real trading activity and latency.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="6" data-code-annotation="2">Generate a random number from standard normal distribution to simulate profit or loss from a trade.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="14" data-code-annotation="3">In this teaching example, we’ve limited the system to produce just five “trades”. In practice, this could be kept running indefinitely via, e.g., <code>while true</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="23" data-code-annotation="4">Create a channel with a buffer size of 32 floats (in this limited example, we could have gotten away with just 5 since that’s how many the demonstration produces). In practice, you want this to be long enough that the consumer of the channel never gets so far behind that the channel fills up. The channel is created outside of the <code>@sync</code> block so that <code>channel</code> is in scope when we <code>close</code> it.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="26" data-code-annotation="5"><code>@sync</code> waits (like <code>wait(task)</code>) for all of the scheduled tasks within the block to complete before proceeding with the rest of the program.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="29,30" data-code-annotation="6"><code>@async</code> does the combination of creating a task via <code>@task</code> and <code>schedule</code>-ing in one, simpler call.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Producer: Trade Result #4 2.213
Monitor: Received 2.213, Cumulative: 2.213
Producer: Trade Result #1 0.761
Monitor: Received 0.761, Cumulative: 2.974
Producer: Trade Result #2 1.343
Monitor: Received 1.343, Cumulative: 4.317
Producer: Trade Result #3 -0.086
Monitor: Received -0.086, Cumulative: 4.231
Producer: Trade Result #5 2.338
Monitor: Received 2.338, Cumulative: 6.569</code></pre>
</div>
</div>
<p>This is really useful for handling events that are “external” to our program. If we were just doing a modeling exercise using static data, then we could control the order of processing and not need to worry about monitoring a volatile source of data. Nonetheless, tasks can still be useful in some cases even if a model is not using “live” data: for example if one of the steps in a model is to load a very large dataset, it may be possible to perform some computations while chunked task requests are queued to load more data from the disk.</p>
<p>A garbage collector will usually clean up unused channels that are still open. However, it’s a good practice to explicitly <code>close</code> them to ensure proper resource management, clear signaling of completion, and to avoid potential blocking or termination issues in your programs.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the task never finishes properly inside the <code>@sync</code>, then your program may get stuck in an infinite loop and hang. Such as if one of the tasks never has a termination condition such as an upper bound on a loop, or a clear way to <code>break</code> out of a <code>while true</code> loop. While not different than a normal loop, such issues become less obvious underneath the layer of task abstractions.</p>
</div>
</div>
<p>The key takeaway for tasks is that it’s a way to chunk work into bundles that can be run in a concurrent fashion, even if nothing is technically being processed in parallel. The multi-threading and parallel programming paradigms sections build off of tasks so an understanding of tasks is helpful. However, some of the higher level libraries hide the task-based building blocks from you as the user/developer and so an intricate understanding of tasks is not required to be successful in parallelizing your Julia code.</p>
</section>
</section>
<section id="multi-threading-overview" class="level3" data-number="11.5.2">
<h3 data-number="11.5.2" class="anchored" data-anchor-id="multi-threading-overview"><span class="header-section-number">11.5.2</span> Multi-Threading Overview</h3>
<p>When a program starts on your computer, the operating system creates a <strong>process</strong>. It allocates bookkeeping structures (to track code, stack frames, and heap allocations) and reserves a block of memory in RAM for that process. Different processes do not have access to each other’s allocated memory.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Readers may be familiar with starting Excel in different processes. When workbooks are opened within the same process (e.g.&nbsp;when creating a new workbook from Excel’s File menu), the workbooks may seamlessly talk to each other (copy and paste from one to another). However, when Microsoft Excel is opened in different processes, then the workbooks in each respective process do not share memory and cannot create links or use full copy/paste functionality between them (this is what happens when you hold the control button and open Excel multiple times).</p>
</div>
</div>
<p>Within each process a main thread is created. That thread is where the running of the code occurs. For the level of the discussion here, you can think of a process as a container with shared memory for threads, which do the real work (as illustrated in <a href="#fig-process-threads" class="quarto-xref">Figure&nbsp;<span>11.2</span></a>). Besides the main thread, other threads can be created within the process and access the same shared memory.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Set the number of Julia threads explicitly via the <code>JULIA_NUM_THREADS</code> environment variable or the <code>--threads</code> flag (for example, <code>julia --threads=auto</code>). This must be done before the session starts; changing it inside a running REPL has no effect.</p>
</div>
</div>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-process-threads" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-process-threads-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<svg width="672" height="480" viewbox="0.00 0.00 296.00 141.60" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 137.6)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-137.6 292,-137.6 292,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<polygon fill="none" stroke="black" points="8,-8 8,-125.6 280,-125.6 280,-8 8,-8"></polygon>
<text text-anchor="middle" x="144" y="-109" font-family="Times,serif" font-size="14.00">Operating System</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<polygon fill="none" stroke="black" points="181,-16 181,-92.8 272,-92.8 272,-16 181,-16"></polygon>
<text text-anchor="middle" x="226.5" y="-76.2" font-family="Times,serif" font-size="14.00">Process ABC</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_2</title>
<polygon fill="none" stroke="black" points="16,-16 16,-92.8 173,-92.8 173,-16 16,-16"></polygon>
<text text-anchor="middle" x="94.5" y="-76.2" font-family="Times,serif" font-size="14.00">process XYZ</text>
</g>
<!-- A -->
<g id="node1" class="node">
<title>A</title>
<polygon fill="none" stroke="black" points="256.98,-60 195.02,-60 195.02,-24 256.98,-24 256.98,-60"></polygon>
<text text-anchor="middle" x="226" y="-37.8" font-family="Times,serif" font-size="14.00">thread 1</text>
</g>
<!-- B -->
<g id="node2" class="node">
<title>B</title>
<polygon fill="none" stroke="black" points="164.98,-60 103.02,-60 103.02,-24 164.98,-24 164.98,-60"></polygon>
<text text-anchor="middle" x="134" y="-37.8" font-family="Times,serif" font-size="14.00">thread 1</text>
</g>
<!-- C -->
<g id="node3" class="node">
<title>C</title>
<polygon fill="none" stroke="black" points="85.98,-60 24.02,-60 24.02,-24 85.98,-24 85.98,-60"></polygon>
<text text-anchor="middle" x="55" y="-37.8" font-family="Times,serif" font-size="14.00">thread 2</text>
</g>
</g>
</svg>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-process-threads-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.2: When a program starts, the operating system creates a process for which multiple threads (a <em>main</em> thread plus optional additional threads) share memory.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The advantage of threads is that within a single physical processor there may be multiple cores. Those cores can access the shared process memory and run tasks from different threads simultaneously. Modern processors commonly have 8-16 cores (consumer) or 64-128+ cores (server), making multi-threading an effective way to utilize available hardware.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Thread jargon varies. A compact glossary to help:</p>
<ul>
<li><strong>Hardware threads</strong> are the execution lanes exposed by the CPU. They are what the operating system schedules on each core.</li>
<li><strong>Operating-system threads</strong> are managed by the kernel and generally map one-to-one to hardware threads. They are heavier to create and destroy than Julia tasks.</li>
<li><strong>Green threads</strong>, <strong>cooperative threads</strong>, <strong>fibers</strong>, or <strong>user threads</strong> are Julia’s lightweight tasks. They live entirely inside the Julia runtime and can be created in large numbers with minimal overhead.</li>
<li><strong>Multi-tasking</strong> is a single core rapidly switching between tasks so multiple activities appear to make progress even without true parallel execution.</li>
</ul>
<p>Parallelism occurs at many layers - hardware, operating system, language runtime, and network - and the terminology is often overloaded. When collaborating, be explicit about which kind of “thread” you mean.</p>
</div>
</div>
<section id="multi-threading-pitfalls" class="level4" data-number="11.5.2.1">
<h4 data-number="11.5.2.1" class="anchored" data-anchor-id="multi-threading-pitfalls"><span class="header-section-number">11.5.2.1</span> Multi-Threading Pitfalls</h4>
<p>Different threads being able to access the same memory is a double-edged sword. It is useful because we do not need to create multiple copies of the data in RAM or in the cache<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and can improve the overall throughput of our usually memory-bandwidth-limited machines. The downside is that if we are mutating the shared data for which our program relies upon, then our program may produce unintended results if the modification occurs carelessly. There are a couple of related issues to be aware of:</p>
<section id="race-conditions" class="level5" data-number="11.5.2.1.1">
<h5 data-number="11.5.2.1.1" class="anchored" data-anchor-id="race-conditions"><span class="header-section-number">11.5.2.1.1</span> Race Conditions</h5>
<p>The first issue is known as a <strong>race condition</strong>, which occurs when a block of memory has been read from or written to in an unintended order. For example, if we have two threads which are accumulating a sub-total, each process may read the running sub-total before the other thread has finished its update.</p>
<p>In the following example, we use the <code>Threads.@threads</code> to tell Julia to automatically distribute the work across threads.</p>
<div id="bb1fb97a" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sum_bad</span>(n)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    subtotal <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        subtotal <span class="op">+=</span> i</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    subtotal</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sum_bad</span>(<span class="fl">100_000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>1897744899</code></pre>
</div>
</div>
<p>The result will be less than the expected sum (<code>5000050000</code>) due to a race condition. Here’s what happens:</p>
<ol type="1">
<li><p>Multiple threads read the current value of&nbsp;<code>subtotal</code>&nbsp;simultaneously.</p></li>
<li><p>Each thread adds its own, local value to that reading.</p></li>
<li><p>Only one thread writes its result back to&nbsp;<code>subtotal</code> first.</p></li>
<li><p>A different thread then overwrites&nbsp;<code>subtotal</code>&nbsp;with its calculation based on the out-dated starting point for <code>subtotal</code>.</p></li>
</ol>
<p>This means some thread contributions are lost when they overwrite each other’s results. The threads may not see each other’s updates, leading to missing values in the final sum.</p>
</section>
</section>
<section id="avoiding-multi-threading-pitfalls" class="level4" data-number="11.5.2.2">
<h4 data-number="11.5.2.2" class="anchored" data-anchor-id="avoiding-multi-threading-pitfalls"><span class="header-section-number">11.5.2.2</span> Avoiding Multi-threading Pitfalls</h4>
<p>We will cover several ways to manage multi-threading race conditions, but it is the recommendation of the authors to primarily utilize higher level library code, which will be demonstrated after covering some of the more basic, manual techniques.</p>
<section id="chunking-up-work-into-single-threaded-work" class="level5" data-number="11.5.2.2.1">
<h5 data-number="11.5.2.2.1" class="anchored" data-anchor-id="chunking-up-work-into-single-threaded-work"><span class="header-section-number">11.5.2.2.1</span> Chunking up work into single-threaded work</h5>
<p>First, let’s level-set with a single-threaded result:</p>
<div id="793e9a19" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sum_single</span>(a)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> a</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        s <span class="op">+=</span> i</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    s</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">sum_single</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">100_000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  1.542 ns (0 allocations: 0 bytes)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>5000050000</code></pre>
</div>
</div>
<p>Note that in the single-threaded case, Julia is able to identify this common pattern and use a shortcut, calculating the sum of the integers <span class="math inline">\(1\)</span> through <span class="math inline">\(n\)</span> as <span class="math inline">\(\frac{n(n+1)}{2}\)</span> through a compiler optimization and essentially avoid the loop entirely.</p>
<p>We can implement a correct threaded version by splitting the work into different threads, each of which is independent. Then, we can aggregate the results of each of the chunks.</p>
<div id="96690b4d" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sum_chunker</span>(a)</span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-7-3" class="code-annotation-target"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">Iterators</span>.<span class="fu">partition</span>(<span class="fl">1</span><span class="op">:</span>a, a <span class="op">÷</span> <span class="bu">Threads</span>.<span class="fu">nthreads</span>())</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-7-5" class="code-annotation-target"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>    tasks <span class="op">=</span> <span class="fu">map</span>(chunks) <span class="cf">do</span> chunk</span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Threads</span>.<span class="pp">@spawn</span> <span class="fu">sum_single</span>(chunk)</span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-7-9" class="code-annotation-target"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a>    chunk_sums <span class="op">=</span> <span class="fu">fetch</span>.(tasks)</span>
<span id="annotated-cell-7-10"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-7-11" class="code-annotation-target"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">sum_single</span>(chunk_sums)</span>
<span id="annotated-cell-7-12"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-13"><a href="#annotated-cell-7-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-7-14"><a href="#annotated-cell-7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-15"><a href="#annotated-cell-7-15" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">sum_chunker</span>(<span class="fl">100_000</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="3" data-code-annotation="1">Split <code>1:a</code> into roughly equal ranges across available threads.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="5" data-code-annotation="2">Launch a task for each chunk to compute a single-threaded sum.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="9" data-code-annotation="3">Fetch each task’s result once it finishes.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="11" data-code-annotation="4">Aggregate the partial sums on a single thread; this is cheap because there are only as many partial sums as threads.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.708 μs (72 allocations: 4.16 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>5000050000</code></pre>
</div>
</div>
</section>
<section id="using-locks" class="level5" data-number="11.5.2.2.2">
<h5 data-number="11.5.2.2.2" class="anchored" data-anchor-id="using-locks"><span class="header-section-number">11.5.2.2.2</span> Using Locks</h5>
<p><strong>Locks</strong> prevent memory from being accessed from more than one thread at a time.</p>
<div id="b5a1a1b0" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sum_with_lock</span>(n)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-8-2" class="code-annotation-target"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>    subtotal <span class="op">=</span> <span class="fl">0</span></span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-8-4" class="code-annotation-target"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>    lock <span class="op">=</span> <span class="fu">ReentrantLock</span>()</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-8-6" class="code-annotation-target"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-8-7" class="code-annotation-target"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Base</span>.<span class="pp">@lock</span> lock <span class="cf">begin</span></span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>            subtotal <span class="op">+=</span> i</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a>    subtotal</span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">sum_with_lock</span>(<span class="fl">100_000</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="2" data-code-annotation="1">Initialize a running total to zero.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="4" data-code-annotation="2">Create a reentrant lock to ensure only one thread updates <code>subtotal</code> at a time.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="6" data-code-annotation="3">Parallelize the loop over 1 to n using <code>Threads.@threads</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="7" data-code-annotation="4">Acquire the lock before updating the shared variable <code>subtotal</code>. This ensures that only one thread updates <code>subtotal</code> at a time, preventing race conditions. The lock is automatically released at the end of the block.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  7.060 ms (209238 allocations: 3.51 MiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>5000050000</code></pre>
</div>
</div>
</section>
<section id="using-atomics" class="level5" data-number="11.5.2.2.3">
<h5 data-number="11.5.2.2.3" class="anchored" data-anchor-id="using-atomics"><span class="header-section-number">11.5.2.2.3</span> Using Atomics</h5>
<p><strong>Atomics</strong> are certain primitive values with a reduced set of operations for which Julia and the compiler can automatically create thread-safe code. This is often significantly faster than the context-switching overhead needed with locking and unlocking memory for threaded tasks. Compared with locks, atomics are simpler to implement and easier to reason about. The downside is that atomics are limited to the available primitive atomics types and methods.</p>
<div id="edfc590e" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-9"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-9-1"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sum_with_atomic</span>(n)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-9-2" class="code-annotation-target"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>    subtotal <span class="op">=</span> <span class="bu">Threads</span>.<span class="fu">Atomic</span><span class="dt">{Int}</span>(<span class="fl">0</span>)</span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-9-4" class="code-annotation-target"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Threads</span>.<span class="fu">atomic_add!</span>(subtotal, i)</span>
<span id="annotated-cell-9-5"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-9-6"><a href="#annotated-cell-9-6" aria-hidden="true" tabindex="-1"></a>    subtotal[]</span>
<span id="annotated-cell-9-7"><a href="#annotated-cell-9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-9-8"><a href="#annotated-cell-9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-9"><a href="#annotated-cell-9-9" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">sum_with_atomic</span>(<span class="fl">100_000</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="2" data-code-annotation="1">Initialize an atomic integer (<code>Threads.Atomic{Int}</code>) to store the subtotal. An atomic variable ensures that increments are performed atomically, preventing race conditions without needing explicit locks.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="4" data-code-annotation="2">Atomically add <code>i</code> to <code>subtotal</code>. The <code>Threads.atomic_add!</code> function ensures that the addition and update of <code>subtotal</code> happens as one atomic step, preventing multiple threads from interfering with each other’s updates.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  1.384 ms (73 allocations: 4.38 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>5000050000</code></pre>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="sec-GPUs" class="level2" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="sec-GPUs"><span class="header-section-number">11.6</span> GPU and TPUs</h2>
<section id="hardware-1" class="level3" data-number="11.6.1">
<h3 data-number="11.6.1" class="anchored" data-anchor-id="hardware-1"><span class="header-section-number">11.6.1</span> Hardware</h3>
<p>Graphics Processing Units (GPUs) and Tensor Processing Units (TPUs) are hardware accelerators for massively parallel computations. A TPU is very similar to a GPU but have special ability to handle data types and instructions that are more specialized for linear algebra operations; going forward we will simply refer to these types of accelerators as GPUs.</p>
<p>GPUs have similar components as the CPU as discussed in <a href="hardware.html" class="quarto-xref"><span>Chapter 9</span></a>. They have RAM, caches for the cores, and cores that run the coded instructions on the data. The differences from a CPU are primarily:</p>
<ul>
<li>A GPU typically has thousands of simple cores, while CPUs have fewer but more sophisticated cores (4-16 on consumer chips, up to 128+ on server chips like AMD EPYC or Intel Xeon).
<ul>
<li>GPU cores operate at <em>slower</em> clock speeds than CPU cores (1-2 GHz vs 3-5 GHz) but achieve throughput through massive parallelism.</li>
</ul></li>
<li>The GPU cores essentially have to be running the same set of instructions on all of the data, not unlike vectorization (<a href="#sec-vectorization" class="quarto-xref"><span>Section 11.4</span></a>).
<ul>
<li>GPU code is not suited for code with branching conditions (e.g.&nbsp;<code>if</code> statements) and so is more limited in the kinds of computations it can handle compared to the CPU.</li>
</ul></li>
<li>GPU memory (VRAM) is typically more constrained than system RAM. Consumer GPUs have 8-24 GB; high-end data center GPUs (NVIDIA H100) have up to 80 GB, while system RAM can easily be 128-512 GB on servers.
<ul>
<li>As a result, GPUs may need strategies to move chunks of data to and from GPU memory for large datasets. Using lower-precision datatypes (e.g., <code>Float16</code> or <code>Float32</code> instead of <code>Float64</code>) is common to fit more data and improve throughput, though this trades off numerical precision.</li>
</ul></li>
<li>The caches are similar in concept to CPU, but unlike most CPU caches, there is relative locality to data (wherein core #1 will have much quicker access to a different subset of data than, say, core #1024).</li>
<li>A GPU is usually a secondary device of sorts: it physically and in device architecture is separate from the CPU. The CPU remains in charge of overall computer execution.
<ul>
<li>The implication of this (as with any movement of memory) is that there is overhead to moving data to and from the GPU. Your calculations will need to be in the single milliseconds range of time in order to start to see benefit from utilizing a GPU.</li>
<li>To some extent, separable CPU, RAM, and GPU are changing with some of the latest computer hardware. For example, the M-series of Apple processors have the CPU, GPU, and RAM in a single tightly integrated package for efficiency and computational power.</li>
</ul></li>
</ul>
<section id="notable-vendors-and-libraries" class="level4" data-number="11.6.1.1">
<h4 data-number="11.6.1.1" class="anchored" data-anchor-id="notable-vendors-and-libraries"><span class="header-section-number">11.6.1.1</span> Notable Vendors and Libraries</h4>
<p>Like the difference between x86 and ARM architectures, GPU also have specific architectures which vary by the vendor. To make full use of the hardware, the vendors need to (1) provide device drivers which allow the CPU to talk to the GPU, and (2) provide the libraries (lower level application programming interfaces, or APIs) which allow developers to utilize different hardware features without needing to write machine code.</p>
<p>As of the mid 2020s, here are the most important GPU vendors and the associated programming library for utilizing their specific hardware:</p>
<table class="caption-top table">
<caption>GPU and TPU vendors with representative hardware and programming interfaces. NVIDIA dominates the data center market; Apple Metal is only available on macOS/iOS.</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 47%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th>Vendor</th>
<th>Hardware Examples</th>
<th>API/Library</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>NVIDIA</td>
<td>GeForce RTX (consumer), Quadro/RTX A-series (professional), A100/H100/H200 (data center)</td>
<td>CUDA</td>
</tr>
<tr class="even">
<td>AMD</td>
<td>Radeon (consumer), Radeon Pro (professional), Instinct MI series (data center)</td>
<td>ROCm (HIP)</td>
</tr>
<tr class="odd">
<td>Intel</td>
<td>Arc (consumer), Data Center GPU Max / Ponte Vecchio (data center)</td>
<td>oneAPI (SYCL)</td>
</tr>
<tr class="even">
<td>Apple</td>
<td>M-series integrated GPU (M1, M2, M3, M4)</td>
<td>Metal</td>
</tr>
<tr class="odd">
<td>Google</td>
<td>TPU v4, v5 (cloud only)</td>
<td>XLA (via JAX or TensorFlow)</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="utilizing-a-gpu" class="level3" data-number="11.6.2">
<h3 data-number="11.6.2" class="anchored" data-anchor-id="utilizing-a-gpu"><span class="header-section-number">11.6.2</span> Utilizing a GPU</h3>
<p>With some of the key conceptual differences between CPUs and GPUs explained, let’s explore how to incorporate these powerful hardware accelerators. We will use Julia libraries to illustrate GPU programming, though the concepts are generally applicable to other high-level languages that offer GPU interface libraries.</p>
<section id="julia-gpu-libraries" class="level4" data-number="11.6.2.1">
<h4 data-number="11.6.2.1" class="anchored" data-anchor-id="julia-gpu-libraries"><span class="header-section-number">11.6.2.1</span> Julia GPU Libraries</h4>
<p>There’s essentially two types of GPU programming we will discuss here:</p>
<ol type="1">
<li><strong>Array-based programming</strong>, where arrays are stored and operated on directly on the GPU memory. This approach abstracts away the low-level details, allowing you to work with familiar array operations that are automatically executed on the GPU.</li>
<li><strong>Custom kernels</strong>, which are specialized functions that define exactly how each GPU thread should process data in parallel. A kernel explicitly specifies the computation that each GPU thread will perform on its portion of the data.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Kernels</strong> in this context are specialized functions that run directly on the GPU. Rather than relying solely on high-level array operations, kernels explicitly define the sequence of low-level, parallel instructions executed across many GPU threads. In other words, a kernel directly expresses the computation you want to perform on the data, enabling fine-grained control over GPU execution.</p>
</div>
</div>
<p>A third approach would be to implement GPU code in a low-level vendor toolkit (such as C++ and associate CUDA libraries), but this approach will not be illustrated here.</p>
<p>Julia has wonderful support for several of the primary vendors (at the time of writing, CUDA, Metal, OneAPI, and ROCm) via the <a href="https://juliagpu.org">JuliaGPU organization</a>. Installation of the required dependencies is also very straightforward and the interfaces at the array and generated kernel levels are very similar. The differences are obvious at the lower level vendor-API wrappers (which is the lower-level technique that will not be covered here).</p>
<p>The benefit of the consistency of the higher level libraries we will use here is that examples written for one of the types of accelerators will be largely directly translatable to another. This is especially true for array programming, though less so for the kernel style as architecture-specific considerations often creep in<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This book will be rendered on a Mac and therefore the examples will use Metal in order to run computational cells, however we’ll show a CUDA translation for some of the examples in order to show how straightforward translating higher level GPU code in Julia is.</p>
</div>
</div>
<table class="caption-top table">
<thead>
<tr class="header">
<th>GPU API</th>
<th>GPU Array Type</th>
<th>Kernel Macro</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CUDA</td>
<td><code>CuArray</code></td>
<td><code>@cuda</code></td>
</tr>
<tr class="even">
<td>Metal</td>
<td><code>MtlArray</code></td>
<td><code>@metal</code></td>
</tr>
<tr class="odd">
<td>oneAPI</td>
<td><code>oneArray</code></td>
<td><code>@oneAPI</code></td>
</tr>
<tr class="even">
<td>ROCm</td>
<td><code>ROCArray</code></td>
<td><code>@roc</code></td>
</tr>
</tbody>
</table>
</section>
<section id="sec-GPU-array" class="level4" data-number="11.6.2.2">
<h4 data-number="11.6.2.2" class="anchored" data-anchor-id="sec-GPU-array"><span class="header-section-number">11.6.2.2</span> Array Programming on the GPU</h4>
<p>First described in <a href="first-abstractions.html#sec-array-oriented-styles" class="quarto-xref"><span>Section 6.5</span></a>, array programming eschews writing loops and instead favors initializing blocks of heap-allocated memory and filling it with data to be operated on at a single point in time. While this is often not the most efficient way to utilize CPUs, it’s essentially the required style of code to utilize GPUs.</p>
<p>For the example below, we will calculate the present value of a series of cashflows across a number of different scenarios. An explanation of the code is given below the example.</p>
<div id="768b5bad" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-10-1"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Metal</span></span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-10-3" class="code-annotation-target"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">calculate_present_values!</span>(present_values, cashflows, discount_matrices)</span>
<span id="annotated-cell-10-4"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform element-wise multiplication and sum along the time dimension</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-10-5" class="code-annotation-target"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a>    present_values <span class="op">.=</span> <span class="fu">sum</span>(cashflows <span class="op">.*</span> discount_matrices, dims<span class="op">=</span><span class="fl">1</span>)</span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-8"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage using 100 time periods, 100k scenarios</span></span>
<span id="annotated-cell-10-9"><a href="#annotated-cell-10-9" aria-hidden="true" tabindex="-1"></a>num_scenarios <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">5</span></span>
<span id="annotated-cell-10-10"><a href="#annotated-cell-10-10" aria-hidden="true" tabindex="-1"></a>pvs <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Float32</span>, <span class="fl">1</span>, num_scenarios)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-10-11" class="code-annotation-target"><a href="#annotated-cell-10-11" aria-hidden="true" tabindex="-1"></a>cashflows <span class="op">=</span> <span class="fu">rand</span>(<span class="dt">Float32</span>, <span class="fl">100</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-10-12" class="code-annotation-target"><a href="#annotated-cell-10-12" aria-hidden="true" tabindex="-1"></a>discount_matrices <span class="op">=</span> <span class="fu">rand</span>(<span class="dt">Float32</span>, <span class="fl">100</span>, num_scenarios)</span>
<span id="annotated-cell-10-13"><a href="#annotated-cell-10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-14"><a href="#annotated-cell-10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># copy the data to the GPU</span></span>
<span id="annotated-cell-10-15"><a href="#annotated-cell-10-15" aria-hidden="true" tabindex="-1"></a>pvs_GPU <span class="op">=</span> <span class="fu">MtlArray</span>(pvs)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-10-16" class="code-annotation-target"><a href="#annotated-cell-10-16" aria-hidden="true" tabindex="-1"></a>cashflows_GPU <span class="op">=</span> <span class="fu">MtlArray</span>(cashflows)</span>
<span id="annotated-cell-10-17"><a href="#annotated-cell-10-17" aria-hidden="true" tabindex="-1"></a>discount_matrices_GPU <span class="op">=</span> <span class="fu">MtlArray</span>(discount_matrices)</span>
<span id="annotated-cell-10-18"><a href="#annotated-cell-10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-19"><a href="#annotated-cell-10-19" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">calculate_present_values!</span>(<span class="op">$</span>pvs, <span class="op">$</span>cashflows, <span class="op">$</span>discount_matrices)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-10-20" class="code-annotation-target"><a href="#annotated-cell-10-20" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">calculate_present_values!</span>(<span class="op">$</span>pvs_GPU, <span class="op">$</span>cashflows_GPU, <span class="op">$</span>discount_matrices_GPU)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="3" data-code-annotation="1">The function <code>calculate_present_values!</code> is written the same way as if we were just writing CPU code. Note that we are also passing a pre-allocated vector, <code>present_values</code> to store the result. This will allow us to isolate the performance of the computation, rather than including any overhead of allocating the array for the result.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="5" data-code-annotation="2">The code is broadcasted across the first dimension so that the single set of cashflows is discounted for each scenario’s discount vector.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="11" data-code-annotation="3">Metal only supports 32-bit floating point (<code>Float32</code>) in GPU shaders. NVIDIA data center GPUs (A100, H100) have full-speed FP64; consumer GPUs (RTX series) have heavily throttled FP64 (often 1/64th the FP32 rate). For financial calculations requiring double precision, this is an important hardware consideration.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="12" data-code-annotation="4">Using 100 thousand scenarios for this example.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="16" data-code-annotation="5"><code>MtlArray(array)</code> will copy the array values to the GPU.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="20" data-code-annotation="6">Note that the data still lives on the GPU and is of the <code>MtlMatrix</code> (a type alias for a 2-D <code>MtlArray</code>).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling Metal [dde4c033-4e86-420c-a63e-0dd931031962] (cache misses: wrong dep version loaded (2), incompatible header (6))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling SparseArraysExt [85068d23-b5fb-53f1-8204-05c2aba6942f] (cache misses: wrong dep version loaded (2), incompatible header (8))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling StructArraysGPUArraysCoreExt [cbbf52aa-d660-55d4-8a5a-33845bbaa85d] (cache misses: wrong dep version loaded (4), incompatible header (10))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling AtomixMetalExt [368c01e8-f8da-5dca-a1ea-818da1f33961] (cache misses: wrong dep version loaded (2), incompatible header (6))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling SpecialFunctionsExt [05d8ebbe-653a-54ed-ba56-24759129d732] (cache misses: wrong dep version loaded (2), incompatible header (6))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up
</pre>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  1.119 ms (6 allocations: 38.55 MiB)
  80.125 μs (298 allocations: 8.59 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>1×100000 MtlMatrix{Float32, Metal.PrivateStorage}:
 21.1515  22.1651  24.0275  22.0954  …  20.6615  23.1388  22.8205  20.8768</code></pre>
</div>
</div>
<p>The testing suggests approximately 200 times faster computation when performed on the GPU. Note however, that does not include the overhead of (1) moving the data to the GPU (in the initial <code>MtlArray(cashflows)</code> call), or (2) returning the data to the CPU (since the return type for the GPU version is <code>MtlArray</code>). We can measure this overhead by wrapping the data transfer inside another function and benchmarking it:</p>
<div id="586bd09c" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode julia code-annotation-code code-with-copy"><code class="sourceCode julia"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">GPU_overhead_test</span>(present_values, cashflows, discount_matrices)</span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a>    pvs_GPU <span class="op">=</span> <span class="fu">MtlArray</span>(present_values)</span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a>    cashflows_GPU <span class="op">=</span> <span class="fu">MtlArray</span>(cashflows)</span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4" aria-hidden="true" tabindex="-1"></a>    discount_matrices_GPU <span class="op">=</span> <span class="fu">MtlArray</span>(discount_matrices)</span>
<span id="annotated-cell-11-5"><a href="#annotated-cell-11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-6"><a href="#annotated-cell-11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_present_values!</span>(pvs_GPU, cashflows_GPU, discount_matrices_GPU)</span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-8"><a href="#annotated-cell-11-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Array</span>(pvs_GPU) <span class="co"># convert to CPU array</span></span>
<span id="annotated-cell-11-9"><a href="#annotated-cell-11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-11-10"><a href="#annotated-cell-11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-11"><a href="#annotated-cell-11-11" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">GPU_overhead_test</span>(<span class="op">$</span>pvs, <span class="op">$</span>cashflows, <span class="op">$</span>discount_matrices)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5.459 ms (3245 allocations: 547.91 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>1×100000 Matrix{Float32}:
 21.1515  22.1651  24.0275  22.0954  …  20.6615  23.1388  22.8205  20.8768</code></pre>
</div>
</div>
<p>With the additional overhead, the computation on the GPU takes more total time than if the work were done just on the CPU. This is a very simple example, and the balance tips heavily in favor of the GPU when:</p>
<ol type="1">
<li>The computational demands are significantly higher (e.g.&nbsp;we were to do more calculations than just a simple multiply/divide/sum).</li>
<li>The data size grows bigger.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The previous example can be translated to CUDA by simply exchanging <code>MtlArray</code> for <code>CuArray</code>.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This example again underscores that hardware parallelization is not an automatic “win” for performance. A lot of uninformed discussion around modeling performance is to simply try to get things to run on the GPU and it is often <em>not</em> the case that the models will run faster. Further, as the modeling logic gets more complex, it does require greater care to keep in mind GPU constraints (acceptable data types, memory limitations, avoiding scalar operations, data transfer between CPU and GPU, etc.). A best practice is to contemplate sequential performance and memory usage before leveraging GPU accelerators.</p>
</div>
</div>
</section>
<section id="kernel-programming-on-the-gpu" class="level4" data-number="11.6.2.3">
<h4 data-number="11.6.2.3" class="anchored" data-anchor-id="kernel-programming-on-the-gpu"><span class="header-section-number">11.6.2.3</span> Kernel Programming on the GPU</h4>
<p>Another approach to GPU programming is often referred to as kernel programming, or being much more explicit about <em>how</em> a computation is performed. This is as opposed to the declarative approach in the array-oriented style (<a href="#sec-GPU-array" class="quarto-xref"><span>Section 11.6.2.2</span></a>) wherein we specified <em>what</em> we wanted the computation to be.</p>
<p>The key ideas here are that we need to manually specify several aspects which came ‘free’ in the array-oriented style. The tradeoff is that we can be more fine-tuned about how the computation leverages our hardware, potentially increasing performance.</p>
<p>The GPU libraries in Julia abstract much of the low level programming typically necessary for this style of programming, but we still need to explicitly look at:</p>
<ol type="1">
<li>How the GPU will iterate across different cores/threads.</li>
<li>How many threads to utilize, the optimal number depends on the shape of the computation (long vectors, multi-dimensional arrays), memory constraints, and hardware specifics.</li>
</ol>
<ul>
<li>GPU threads: Individual units of execution within a kernel. Each thread runs the same kernel code but operates on a different portion of the data.</li>
</ul>
<ol start="3" type="1">
<li>How to chunk (group) the data to distribute the data to the different GPU threads</li>
</ol>
<p>Our strategy for the present values example will be to distribute the work such that different GPU threads are working on different scenarios. Within a scenario, the loop is a very familiar approach: initialize a subtotal to zero and then accumulate the calculated present values.</p>
<div id="d1547065" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">calculate_present_values_kernel!</span>(present_values, cashflows, discount_matrices)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-12-2" class="code-annotation-target"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="fu">thread_position_in_grid_1d</span>()</span>
<span id="annotated-cell-12-3"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-12-4" class="code-annotation-target"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a>    pv <span class="op">=</span> <span class="fl">0.0f0</span></span>
<span id="annotated-cell-12-5"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(cashflows, <span class="fl">1</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-12-6" class="code-annotation-target"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a>        pv <span class="op">+=</span> cashflows[t] <span class="op">*</span> discount_matrices[t, idx]</span>
<span id="annotated-cell-12-7"><a href="#annotated-cell-12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-12-8"><a href="#annotated-cell-12-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-12-9" class="code-annotation-target"><a href="#annotated-cell-12-9" aria-hidden="true" tabindex="-1"></a>    present_values[idx] <span class="op">=</span> pv</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-12-10" class="code-annotation-target"><a href="#annotated-cell-12-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="annotated-cell-12-11"><a href="#annotated-cell-12-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="2" data-code-annotation="1">As the work is distributed across threads, <code>thread_position_in_grid_1d()</code> will give the index of the current thread so that we can index data appropriately for the work as we decide to split it up (we’ve split up the work by scenario in this example).</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="4" data-code-annotation="2">Recall that we are working with <code>Float32</code> on the GPU here, so the zero value is set via the <code>f0</code> notation indicating a 32-bit floating point number.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="6" data-code-annotation="3">The loop is across timesteps within each thread, while the thread index is tracked with <code>idx</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="9" data-code-annotation="4">The result is written to the pre-allocated array of present values, and we avoid race conditions because the different threads are working on different scenarios.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="10" data-code-annotation="5">We don’t explicitly have to <code>return nothing</code> here, but it makes it extra clear that the intention of the function is to mutate the <code>present_values</code> array given to it. This mutation intention is also signaled by the <code>!</code> convention in the function name.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>calculate_present_values_kernel! (generic function with 1 method)</code></pre>
</div>
</div>
<p>The kernel above was fairly similar to how we might write code for CPU-threaded approaches, but we now need to specify the technicals of launching this on the GPU. The <code>threads</code> defines how many independent calculations to run at a given time, and the maximum will be dependent on the hardware used. The <code>groups</code> argument defines the number of threads that share memory and synchronize results together (meaning that group will wait for all threads to finish before moving onto the next chunk of data). The push-pull here is that threads that can share data avoid needing to create duplicate copies of that data in memory. However, if there is variability in how long each calculation will take, then the waiting time for synchronizing results may slow the overall computation down.</p>
<p>Our task utilizes shared memory of the cashflows for each thread, so through some experimentation in advance, we find that a relatively large group size of ~512 is optimal.</p>
<p>We bring this all together through the use of the kernel macro <code>@metal</code>:</p>
<div id="e620864b" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>threads <span class="op">=</span> <span class="fl">1024</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>groups <span class="op">=</span> <span class="fu">cld</span>(num_scenarios, <span class="fl">512</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="pp">@metal</span> threads <span class="op">=</span> <span class="op">$</span>threads groups <span class="op">=</span> <span class="op">$</span>groups <span class="fu">calculate_present_values_kernel!</span>(</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">$</span>pvs_GPU,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">$</span>cashflows_GPU,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">$</span>discount_matrices_GPU</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  15.708 μs (73 allocations: 1.70 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Metal.HostKernel{typeof(calculate_present_values_kernel!), Tuple{MtlDeviceMatrix{Float32, 1}, MtlDeviceVector{Float32, 1}, MtlDeviceMatrix{Float32, 1}}}(Main.calculate_present_values_kernel!, Metal.MTL.MTLComputePipelineStateInstance (object of type AGXG16XFamilyComputePipeline))</code></pre>
</div>
</div>
<p>This is approximately seven times faster than the array-oriented style above, meaning that the GPU kernel version’s computation is over 1000 times faster than the CPU version. However, we saw previously that the cost of moving the data to the GPU memory and then back to the CPU memory was the biggest time sink of all - again we’d need to have more scale in the problem to make offloading to the GPU beneficial overall.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Metal GPUs are able to iterate threads across three different dimensions. In the prior example, we only used one dimension and thus used <code>thread_position_in_grid_1d()</code>. If we were distributing the threads across, say, two dimensions then we would use <code>thread_position_in_grid_2d()</code>.</p>
<p>How do you determine how many dimensions to use? A good approach is to mimic the data you are trying to parallelize. In the example of calculating a vector of present values across 100k scenarios, that was the primary ‘axis of parallelization’. If instead of a one-dimensional set of cashflows (e.g.&nbsp;a single asset with fixed cashflows), we had a two-dimensional set of cashflows (e.g.&nbsp;a portfolio of many assets), then we may find the best balance of code simplicity and performance to iterate across two dimensions of threads (but we are still limited by the same number of total available threads).</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The above example would be translated to CUDA by changing just a few things:</p>
<ul>
<li>The thread indexing would be <code>idx = threadIdx().x</code> instead of <code>i = thread_position_in_grid_1d()</code></li>
<li>The GPU arrays should be created with <code>CuArray</code> instead of <code>MtlArray</code>.</li>
<li>The kernel macro would be <code>@cuda threads=1024 calculate_present_values_kernel!(...)</code> instead of <code>@metal threads=threads groups=groups calculate_present_values_kernel(...)</code>. The memory sharing and synchronizing between threads is more manual than Metal.jl, but this is not strictly necessary for our example.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">calculate_present_values_kernel!</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    present_values,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    cashflows, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    discount_matrices</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="fu">threadIdx</span>().x </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    pv <span class="op">=</span> <span class="fl">0.0f0</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(cashflows, <span class="fl">1</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        pv <span class="op">+=</span> cashflows[t] <span class="op">*</span> discount_matrices[t, idx]</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    present_values[idx] <span class="op">=</span> pv</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>groups <span class="op">=</span> <span class="fu">cld</span>(num_scenarios, <span class="fl">512</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="pp">@cuda</span> threads<span class="op">=</span>threads <span class="fu">calculate_present_values_kernel!</span>(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    pvs_GPU,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    cashflows_GPU, </span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    discount_matrices_GPU</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</section>
</section>
</section>
<section id="sec-multi-device" class="level2" data-number="11.7">
<h2 data-number="11.7" class="anchored" data-anchor-id="sec-multi-device"><span class="header-section-number">11.7</span> Multi-Processing / Multi-Device</h2>
<p>Multiple device, or <strong>multi-device</strong> computer refers to using separate groups of memory/processor combinations to accomplish tasks in parallel. This can be as simple as multiple distinct cores on within a single desktop computer, or many separate computers networked across the internet, or many processors within a high performance cluster or a computing-as-a-service provider like Amazon Web Services or JuliaHub.</p>
<p>Everything discussed previously related to hardware (<a href="hardware.html" class="quarto-xref"><span>Chapter 9</span></a>, <a href="#sec-multithreading" class="quarto-xref"><span>Section 11.5</span></a>, <a href="#sec-GPUs" class="quarto-xref"><span>Section 11.6</span></a>) continues to apply. The additional complexity is attempting to synchronize the computation across multiple sets of the same (homogeneous) or different (heterogeneous) hardware.</p>
<p>As you might imagine, approaches to multi-device computing can vary widely. Julia’s approach tries to strike the balance between capability and user-friendliness and uses a primary/worker model wherein one of the processors is the main coordinator while other processors are “workers”. If only one processor is started, then the main processor is also a worker processor. This main/worker approach uses a “one-sided” approach to coordination. The main worker utilizes high level calls and the workers respond, with some of the communication and hand-off handled by Julia transparently from the user’s perspective.</p>
<p>A useful mental model is the asynchronous task-based concepts discussed in <a href="#sec-tasks" class="quarto-xref"><span>Section 11.5.1</span></a>, as the main worker will effectively queue work with the worker processors. Because there may be a delay associated with the computation or the communication between the processors, the worker runs asynchronously.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Description</th>
<th>Task API</th>
<th>Distributed Analogue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Create a new task</td>
<td><code>Task()</code></td>
<td><code>@spawnat</code></td>
</tr>
<tr class="even">
<td>Run task asynchronously</td>
<td><code>@async</code></td>
<td><code>@spawnat</code></td>
</tr>
<tr class="odd">
<td>Retrieve task result</td>
<td><code>fetch</code></td>
<td><code>fetch</code></td>
</tr>
<tr class="even">
<td>Wait for task completion</td>
<td><code>@sync</code></td>
<td><code>sync</code></td>
</tr>
<tr class="odd">
<td>Communication between tasks</td>
<td><code>Channel</code></td>
<td><code>RemoteChannel</code></td>
</tr>
</tbody>
</table>
<p>Adapting the trade producer and monitor example from above to run on multiple processors (see <a href="#sec-channels" class="quarto-xref"><span>Section 11.5.1.1</span></a> to review the base model and algorithm), we make a few key changes:</p>
<ul>
<li><code>using Distributed</code> loads the Distributed standard Julia library, providing the interface for multi-processing across different hardware.</li>
<li><code>addprocs(n)</code> will add <code>n</code> worker processors (the main processor is already counted as one worker). When adding local machine processors, the processors are part of the local machine. This starts new Julia processes (you can see this in the task manager of the machine) which inherit the package environment (i.e.&nbsp;<code>Project.toml</code> and environment variables) from the main process; this does not occur automatically if not part of the same local machine.
<ul>
<li>To add processors from other machines, see the <a href="https://docs.julialang.org/en/v1/stdlib/Distributed/">Distributed Computing</a> section of the Julia docs.</li>
</ul></li>
<li><code>myid()</code> is the identification number of the given processor that’s been spun up.</li>
<li>We use a <code>RemoteChannel</code> instead of a <code>Channel</code> to facilitate communication across processors.</li>
<li>Instead of <code>@async</code>, we use <code>@spawnat n</code> to create a task for processor number <code>n</code> (or <code>:any</code> will automatically assign a processor).</li>
</ul>
<div id="26080631" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode julia code-annotation-code code-with-copy"><code class="sourceCode julia"><span id="annotated-cell-14-1"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributed</span></span>
<span id="annotated-cell-14-2"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add worker processes if not already added</span></span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">nworkers</span>() <span class="op">==</span> <span class="fl">1</span></span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addprocs</span>(<span class="fl">4</span>)  <span class="co"># Add 4 worker processes</span></span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-8"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">Random</span></span>
<span id="annotated-cell-14-9"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-10"><a href="#annotated-cell-14-10" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">trade_producer</span>(channel, i)</span>
<span id="annotated-cell-14-11"><a href="#annotated-cell-14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span>(<span class="fu">rand</span>())</span>
<span id="annotated-cell-14-12"><a href="#annotated-cell-14-12" aria-hidden="true" tabindex="-1"></a>    profit <span class="op">=</span> <span class="fu">randn</span>()</span>
<span id="annotated-cell-14-13"><a href="#annotated-cell-14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">put!</span>(channel, profit)</span>
<span id="annotated-cell-14-14"><a href="#annotated-cell-14-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Producer </span><span class="sc">$</span>(<span class="fu">myid</span>())<span class="st">: Trade #</span><span class="sc">$</span>i<span class="st"> </span><span class="sc">$</span>(<span class="fu">round</span>(profit, digits<span class="op">=</span><span class="fl">3</span>))<span class="st">"</span>)</span>
<span id="annotated-cell-14-15"><a href="#annotated-cell-14-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-14-16"><a href="#annotated-cell-14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-17"><a href="#annotated-cell-14-17" aria-hidden="true" tabindex="-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">portfolio_monitor</span>(channel, n)</span>
<span id="annotated-cell-14-18"><a href="#annotated-cell-14-18" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="annotated-cell-14-19"><a href="#annotated-cell-14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="annotated-cell-14-20"><a href="#annotated-cell-14-20" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> <span class="fu">take!</span>(channel)</span>
<span id="annotated-cell-14-21"><a href="#annotated-cell-14-21" aria-hidden="true" tabindex="-1"></a>        total <span class="op">+=</span> profit</span>
<span id="annotated-cell-14-22"><a href="#annotated-cell-14-22" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> <span class="fu">round</span>(profit, digits<span class="op">=</span><span class="fl">3</span>)</span>
<span id="annotated-cell-14-23"><a href="#annotated-cell-14-23" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> <span class="fu">round</span>(total, digits<span class="op">=</span><span class="fl">3</span>)</span>
<span id="annotated-cell-14-24"><a href="#annotated-cell-14-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(<span class="st">"Monitor </span><span class="sc">$</span>(<span class="fu">myid</span>())<span class="st">: Received </span><span class="sc">$</span>p<span class="st">, Cumulative: </span><span class="sc">$</span>s<span class="st">"</span>)</span>
<span id="annotated-cell-14-25"><a href="#annotated-cell-14-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-14-26"><a href="#annotated-cell-14-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-14-27"><a href="#annotated-cell-14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-28"><a href="#annotated-cell-14-28" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run_distributed_simulation</span>()</span>
<span id="annotated-cell-14-29"><a href="#annotated-cell-14-29" aria-hidden="true" tabindex="-1"></a>    channel <span class="op">=</span> <span class="fu">RemoteChannel</span>(() <span class="op">-&gt;</span> <span class="fu">Channel</span><span class="dt">{Float64}</span>(<span class="fl">32</span>))</span>
<span id="annotated-cell-14-30"><a href="#annotated-cell-14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-31"><a href="#annotated-cell-14-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start producer and consumer tasks</span></span>
<span id="annotated-cell-14-32"><a href="#annotated-cell-14-32" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="cf">begin</span></span>
<span id="annotated-cell-14-33"><a href="#annotated-cell-14-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span id="annotated-cell-14-34"><a href="#annotated-cell-14-34" aria-hidden="true" tabindex="-1"></a>            <span class="pp">@spawnat</span> <span class="op">:</span>any <span class="fu">trade_producer</span>(channel, i)</span>
<span id="annotated-cell-14-35"><a href="#annotated-cell-14-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-14-36"><a href="#annotated-cell-14-36" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@spawnat</span> <span class="op">:</span>any <span class="fu">portfolio_monitor</span>(channel, <span class="fl">5</span>)</span>
<span id="annotated-cell-14-37"><a href="#annotated-cell-14-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-14-38"><a href="#annotated-cell-14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-39"><a href="#annotated-cell-14-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Close the channel and wait for tasks to finish</span></span>
<span id="annotated-cell-14-40"><a href="#annotated-cell-14-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">close</span>(channel)</span>
<span id="annotated-cell-14-41"><a href="#annotated-cell-14-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="annotated-cell-14-42"><a href="#annotated-cell-14-42" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-14-43"><a href="#annotated-cell-14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-44"><a href="#annotated-cell-14-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the simulation</span></span>
<span id="annotated-cell-14-45"><a href="#annotated-cell-14-45" aria-hidden="true" tabindex="-1"></a><span class="fu">run_distributed_simulation</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      From worker 2:    Producer 2: Trade #1 2.125
      From worker 3:    Monitor 3: Received 2.125, Cumulative: 2.125
      From worker 2:    Producer 2: Trade #5 0.386
      From worker 3:    Monitor 3: Received 0.386, Cumulative: 2.511
      From worker 3:    Producer 3: Trade #2 -0.337
      From worker 3:    Monitor 3: Received -0.337, Cumulative: 2.174
      From worker 3:    Monitor 3: Received 0.324, Cumulative: 2.498
      From worker 4:    Producer 4: Trade #3 0.324
      From worker 3:    Monitor 3: Received 0.767, Cumulative: 3.265
      From worker 5:    Producer 5: Trade #4 0.767</code></pre>
</div>
</div>
<p>Given the similarity to the single-process task-based version above, what’s the motivation for bothering with a distributed approach? A few differences:</p>
<ul>
<li>In this simplified example, we are simply starting additional Julia processes on the same machine. Like with a threaded approach, the work will be split across the same multi-core processor. In this context, the main difference is that the processes do not share memory.
<ul>
<li>Communicating across processes generally has a little bit more overhead than communicating across threads.</li>
</ul></li>
<li>If distributing across machines, avoiding memory sharing is advantageous if using different machines that have their own memory stores, which need not compete with the main process (such as distributed chunks of large datasets). This essentially helps with memory constrained problems since you are no longer limited by the memory size or throughput of a single machine.</li>
<li>The worker processors don’t need to be the same architecture as the main processor, allowing use of different machines or cloud computing that is communicating with a local main process.</li>
</ul>
</section>
<section id="sec-parallel-programming-models" class="level2" data-number="11.8">
<h2 data-number="11.8" class="anchored" data-anchor-id="sec-parallel-programming-models"><span class="header-section-number">11.8</span> Parallel Programming Models</h2>
<p>The previous sections have explained the different parallel programming models and how to directly utilize them to harness additional computing power. Each approach (multi-threading, GPU, distributed processing, etc.) has unique considerations and trade-offs. These approaches in Julia are generally much more accessible to beginning and intermediate users than other languages, but admittedly still requires a decent amount of thought and care.</p>
<p>It is possible, if you are willing to give up some fine-grained control, to utilize some higher level approaches which look to abstract away some of the particularities of the implementation.</p>
<section id="map-reduce" class="level3" data-number="11.8.1">
<h3 data-number="11.8.1" class="anchored" data-anchor-id="map-reduce"><span class="header-section-number">11.8.1</span> Map-Reduce</h3>
<p>Map-Reduce (<a href="first-abstractions.html#sec-map-reduce" class="quarto-xref"><span>Section 6.4.4</span></a>) operations are inherently parallelizable and various libraries provide parallelized versions of the base <code>mapreduce</code>. This is the workhorse function of many ‘big data’ workloads, and many statistical operations are versions of <code>mapreduce</code>.</p>
<section id="multi-threading" class="level4" data-number="11.8.1.1">
<h4 data-number="11.8.1.1" class="anchored" data-anchor-id="multi-threading"><span class="header-section-number">11.8.1.1</span> Multi-Threading</h4>
<section id="ohmythreads" class="level5" data-number="11.8.1.1.1">
<h5 data-number="11.8.1.1.1" class="anchored" data-anchor-id="ohmythreads"><span class="header-section-number">11.8.1.1.1</span> OhMyThreads</h5>
<p><a href="https://github.com/JuliaFolds2/OhMyThreads.jl">OhMyThreads.jl</a> provides the threaded versions of essential functions such as <code>tmap</code>, <code>tmapreduce</code>,<code>tcollect</code>, and <code>tforeach</code> (see <a href="first-abstractions.html#tbl-functional-methods" class="quarto-xref">Table&nbsp;<span>6.1</span></a>). In most cases, the chunking and data sharing is handled automatically for you.</p>
<div id="37c201e6" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">OhMyThreads</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> OhMyThreads.<span class="fu">tmapreduce</span>(x <span class="op">-&gt;</span> x, <span class="op">+</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100_000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling BangBangStaticArraysExt [a9f1882a-14fa-573e-a12d-824431257a23] (cache misses: wrong dep version loaded (6), incompatible header (8), mismatched flags (4))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up
</pre>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  7.708 μs (75 allocations: 4.20 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>5000050000</code></pre>
</div>
</div>
</section>
<section id="threadsx" class="level5" data-number="11.8.1.1.2">
<h5 data-number="11.8.1.1.2" class="anchored" data-anchor-id="threadsx"><span class="header-section-number">11.8.1.1.2</span> ThreadsX</h5>
<p><a href="https://github.com/JuliaFolds2/ThreadsX.jl">ThreadsX.jl</a> is built off of the wonderful <a href="https://github.com/JuliaFolds2/Transducers.jl">Transducers.jl</a> package, though the latter is a bit more advanced (more abstract, but as a result more composable and powerful). ThreadsX provides threaded versions of many popular base functions. It offers a wider set of ready-made threaded functions, but has a much more complex codebase. For the vast majority of threading needs, OhMyThreads.jl should be sufficient and performant. See the documentation for all of the implemented functions, but for our illustrative example:</p>
<div id="e856216b" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">ThreadsX</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> ThreadsX.<span class="fu">mapreduce</span>(x <span class="op">-&gt;</span> x, <span class="op">+</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100_000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling DistributionsTestExt [ffbe0ea5-a612-5ff7-aaf5-cac02eef3019] (cache misses: wrong dep version loaded (6), wrong source (2), incompatible header (8), mismatched flags (2))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up
</pre>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  40.916 μs (890 allocations: 47.64 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>5000050000</code></pre>
</div>
</div>
</section>
</section>
<section id="multi-processing" class="level4" data-number="11.8.1.2">
<h4 data-number="11.8.1.2" class="anchored" data-anchor-id="multi-processing"><span class="header-section-number">11.8.1.2</span> Multi-Processing</h4>
<p><code>reduce(op,pmap(f,collection))</code> will use a distributed map and reduce the resulting map on the main thread. This pattern works well if each application of <code>f</code> to elements of <code>collection</code> is costly.</p>
<p><code>@distributed (op) for x in collection; f(x); end</code> is a way to write the loop with the reduction <code>op</code> for which the <code>f</code> need not be costly.</p>
<p>The difference between the two approaches is that, with <code>pmap</code>, <code>collection</code> is made available to all workers. In the <code>@distributed</code> approach, the collection is partitioned and only a subset is sent to the designated workers.</p>
<p>Here’s an example of both of these, calculating a simple example of counting coin flips:</p>
<div id="cabda051" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is an example of poor utilization of pmap, since the operation is </span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fast and the overhead of moving the whole collection dominates</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">reduce</span>(<span class="op">+</span>, <span class="fu">pmap</span>(x <span class="op">-&gt;</span> <span class="fu">rand</span>((<span class="fl">0</span>, <span class="fl">1</span>)), <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">^</span><span class="fl">3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  79.042 ms (214487 allocations: 10.02 MiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>486</code></pre>
</div>
</div>
<div id="bdd34825" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dist_demo</span>()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@distributed</span> (<span class="op">+</span>) <span class="cf">for</span> _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">^</span><span class="fl">5</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rand</span>((<span class="fl">0</span>, <span class="fl">1</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">dist_demo</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  180.209 μs (335 allocations: 14.52 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>49778</code></pre>
</div>
</div>
</section>
</section>
<section id="array-based" class="level3" data-number="11.8.2">
<h3 data-number="11.8.2" class="anchored" data-anchor-id="array-based"><span class="header-section-number">11.8.2</span> Array-Based</h3>
<p>Array-based approaches will often utilize the parallelism of SIMD on the CPU or many cores on the GPU. It’s as simple as using generic library calls which will often be optimized at the compiler level. Examples:</p>
<div id="8e6c0334" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">rand</span>(<span class="dt">Float32</span>, <span class="fl">10</span><span class="op">^</span><span class="fl">8</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    x_GPU <span class="op">=</span> <span class="fu">MtlArray</span>(x)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@btime</span> <span class="fu">sum</span>(<span class="op">$</span>x)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@btime</span> <span class="fu">sum</span>(<span class="op">$</span>x_GPU)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  4.922 ms (958 allocations: 48.73 KiB)
  1.287 ms (397 allocations: 10.48 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>5.000047f7</code></pre>
</div>
</div>
<p><code>sum(x)</code> compiles to SIMD instructions on the CPU, while using the GPU array type in <code>sum(x_GPU)</code> is enough to let the compiler dispatch on the GPU type and emit efficient, parallelized code for the GPU.</p>
<p>Distributed array types allow for large datasets to effectively be partitioned across multiple processors, and have implementations in the <a href="https://juliaparallel.org/DistributedArrays.jl/stable/">DistributedArrays.jl</a> and <a href="https://juliaparallel.org/Dagger.jl/dev/darray/">Dagger.jl</a> libraries.</p>
</section>
<section id="loop-based" class="level3" data-number="11.8.3">
<h3 data-number="11.8.3" class="anchored" data-anchor-id="loop-based"><span class="header-section-number">11.8.3</span> Loop-Based</h3>
<p>Loops that don’t have race conditions can easily become multi-threaded. Here, we have three versions of updating a collection to square the contained values:</p>
<p>Basic single-threaded:</p>
<div id="8076eb5b" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> v <span class="op">=</span> <span class="fu">collect</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">10000</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(v)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        v[i] <span class="op">=</span> v[i]<span class="op">^</span><span class="fl">2</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    v[<span class="fl">1</span><span class="op">:</span><span class="fl">3</span>]</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>3-element Vector{Int64}:
 1
 4
 9</code></pre>
</div>
</div>
<p>Using multi-threading:</p>
<div id="40c0877b" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> v <span class="op">=</span> <span class="fu">collect</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">10000</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(v)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>        v[i] <span class="op">=</span> v[i]<span class="op">^</span><span class="fl">2</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    v[<span class="fl">1</span><span class="op">:</span><span class="fl">3</span>]</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>3-element Vector{Int64}:
 1
 4
 9</code></pre>
</div>
</div>
<p>Using multi-processing:</p>
<div id="92c62add" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">SharedArrays</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> <span class="fu">collect</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">10_000</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    sV <span class="op">=</span> <span class="fu">SharedArray</span><span class="dt">{eltype(v)}</span>(<span class="fu">length</span>(v))</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@sync</span> <span class="bu">Distributed</span>.<span class="pp">@distributed</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(v)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        sV[i] <span class="op">=</span> v[i]<span class="op">^</span><span class="fl">2</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    sV[<span class="fl">1</span><span class="op">:</span><span class="fl">3</span>]</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>3-element Vector{Int64}:
 1
 4
 9</code></pre>
</div>
</div>
<p>For more advanced usage, including handling shared memory see <a href="#sec-multi-device" class="quarto-xref"><span>Section 11.7</span></a> and <a href="#sec-multithreading" class="quarto-xref"><span>Section 11.5</span></a>.</p>
</section>
<section id="task-based" class="level3" data-number="11.8.4">
<h3 data-number="11.8.4" class="anchored" data-anchor-id="task-based"><span class="header-section-number">11.8.4</span> Task-Based</h3>
<p>Task-based approaches attempt to abstract the scheduling and distribution of work from the user. Instead of saying how the computation should be done, the user specifies the intended operations and allows the library to handle the workflow. The main library for this in Julia is <a href="https://juliaparallel.org/Dagger.jl/dev/darray/">Dagger.jl</a>.</p>
<p>Effectively, the library establishes a network topology (a map of how different processor nodes can communicate) and models the work as a directed, acyclic graph (a DAG, which is like a map of how the work is related). The library is then able to assign the work in the appropriate order to the available computation devices. The benefit of this is most apparent with complex workflows or network topologies where it would be difficult to manually assign, communicate, and schedule the workflow.</p>
<p>Here’s a very simple example which demonstrates Dagger waiting for the two tasks which work in parallel (we already added multiple processors to this environment in <a href="#sec-multi-device" class="quarto-xref"><span>Section 11.7</span></a>):</p>
<div id="c17897c5" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Dagger</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This runs first:</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> Dagger.<span class="pp">@spawn</span> <span class="fu">rand</span>(<span class="fl">100</span>, <span class="fl">100</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># These run in parallel:</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> Dagger.<span class="pp">@spawn</span> <span class="fu">sum</span>(a)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Dagger.<span class="pp">@spawn</span> <span class="fu">prod</span>(a)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Finally, this runs:</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> Dagger.<span class="pp">@spawn</span> <span class="fu">println</span>(<span class="st">"b: "</span>, b, <span class="st">", c: "</span>, c)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="fu">wait</span>(d)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling Dagger [d58978e5-989f-55fb-8d15-ea34adc7bf54] (cache misses: wrong dep version loaded (2), incompatible header (4))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

WARNING: Constructor for type "Extrema" was extended in `OnlineStats` without explicit qualification or import.

  NOTE: Assumed "Extrema" refers to `OnlineStatsBase.Extrema`. This behavior is deprecated and may differ in future versions.`

  NOTE: This behavior may have differed in Julia versions prior to 1.12.

  Hint: If you intended to create a new generic function of the same name, use `function Extrema end`.

  Hint: To silence the warning, qualify `Extrema` as `OnlineStatsBase.Extrema` in the method signature or explicitly `import OnlineStatsBase: Extrema`.

<span class="ansi-yellow-fg ansi-bold">┌ </span><span class="ansi-yellow-fg ansi-bold">Warning: </span>Precompile failed to clean up all tasks

<span class="ansi-yellow-fg ansi-bold">└ </span><span class="ansi-bright-black-fg">@ Dagger ~/.julia/packages/Dagger/0Eq6X/src/precompile.jl:21</span>



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling TransducersOnlineStatsBaseExt [6f45943c-d98e-5e8a-8912-adbe5bfabdb6] (cache misses: wrong dep version loaded (2), incompatible header (4))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling AbstractFFTsExt [f3632cd0-faf9-5a79-8070-e21d1a1ecff6] (cache misses: wrong dep version loaded (2), incompatible header (4))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling DistributionsExt [c815768c-a342-5444-8dea-b375f31b26a5] (cache misses: wrong dep version loaded (2), incompatible header (4))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling GraphVizSimpleExt [8f367522-86d3-5221-bdf5-df974a7b0ff8] (cache misses: wrong dep version loaded (2), incompatible header (4))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up

<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Precompiling MetalExt [749d1e2e-b2a6-505a-add8-46168822f7b1] (cache misses: wrong dep version loaded (2), incompatible header (4))



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up



SYSTEM: caught exception of type :MethodError while trying to print a failed Task notice; giving up
</pre>
</div>
</div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>      From worker 5:   <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 4:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 3:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 2:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 5:        TimespanLogging<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/TimespanLogging/7jl94_72NES.ji.pidfile)</span>

      From worker 4:        TimespanLogging<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/TimespanLogging/7jl94_72NES.ji.pidfile)</span>

      From worker 2:        TimespanLogging<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/TimespanLogging/7jl94_72NES.ji.pidfile)</span>

      From worker 5:        MemPool<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/MemPool/O6V9j_72NES.ji.pidfile)</span>

      From worker 4:        MemPool<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/MemPool/O6V9j_72NES.ji.pidfile)</span>

      From worker 5:        OnlineStatsBase<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/OnlineStatsBase/UqZRb_72NES.ji.pidfile)</span>

      From worker 4:        OnlineStatsBase<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/OnlineStatsBase/UqZRb_72NES.ji.pidfile)</span>

      From worker 5:        ArnoldiMethod<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/ArnoldiMethod/zP00S_72NES.ji.pidfile)</span>

      From worker 2:        MemPool<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/MemPool/O6V9j_72NES.ji.pidfile)</span>

      From worker 4:        ArnoldiMethod<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/ArnoldiMethod/zP00S_72NES.ji.pidfile)</span>

      From worker 5:        KernelAbstractions<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/KernelAbstractions/aywHT_72NES.ji.pidfile)</span>

      From worker 2:        OnlineStatsBase<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/OnlineStatsBase/UqZRb_72NES.ji.pidfile)</span>

      From worker 4:        KernelAbstractions<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/KernelAbstractions/aywHT_72NES.ji.pidfile)</span>

      From worker 2:        ArnoldiMethod<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/ArnoldiMethod/zP00S_72NES.ji.pidfile)</span>

      From worker 2:        KernelAbstractions<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/KernelAbstractions/aywHT_72NES.ji.pidfile)</span>

      From worker 3:        561.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStatsBase</span>

      From worker 4:        485.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStatsBase</span>

      From worker 4:        OnlineStats<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/OnlineStats/G3mU6_72NES.ji.pidfile)</span>

      From worker 5:        506.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStatsBase</span>

      From worker 5:        OnlineStats<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/OnlineStats/G3mU6_72NES.ji.pidfile)</span>

      From worker 2:        523.9 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStatsBase</span>

      From worker 2:        OnlineStats<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/OnlineStats/G3mU6_72NES.ji.pidfile)</span>

      From worker 3:        788.4 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">TimespanLogging</span>

      From worker 5:        791.4 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">TimespanLogging</span>

      From worker 4:        794.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">TimespanLogging</span>

      From worker 2:        797.0 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">TimespanLogging</span>

      From worker 3:        984.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">MemPool</span>

      From worker 2:        887.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">MemPool</span>

      From worker 5:        892.1 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">MemPool</span>

      From worker 4:        895.8 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">MemPool</span>

      From worker 3:       1005.4 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">ArnoldiMethod</span>

      From worker 4:        988.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">ArnoldiMethod</span>

      From worker 4:        Graphs<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/Graphs/VJ6vx_72NES.ji.pidfile)</span>

      From worker 2:        998.3 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">ArnoldiMethod</span>

      From worker 2:        Graphs<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/Graphs/VJ6vx_72NES.ji.pidfile)</span>

      From worker 5:       1006.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">ArnoldiMethod</span>

      From worker 5:        Graphs<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/Graphs/VJ6vx_72NES.ji.pidfile)</span>

      From worker 3:       1664.5 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions</span>

      From worker 2:       1646.9 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions</span>

      From worker 2:        SparseArraysExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/SparseArraysExt/TR6ym_72NES.ji.pidfile)</span>

      From worker 2:        LinearAlgebraExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/LinearAlgebraExt/1TyTB_72NES.ji.pidfile)</span>

      From worker 5:       1660.7 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions</span>

      From worker 5:        SparseArraysExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/SparseArraysExt/TR6ym_72NES.ji.pidfile)</span>

      From worker 5:        LinearAlgebraExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/LinearAlgebraExt/1TyTB_72NES.ji.pidfile)</span>

      From worker 4:       1670.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions</span>

      From worker 4:        SparseArraysExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/SparseArraysExt/TR6ym_72NES.ji.pidfile)</span>

      From worker 4:        LinearAlgebraExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/LinearAlgebraExt/1TyTB_72NES.ji.pidfile)</span>

      From worker 3:       1612.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStats</span>

      From worker 4:       1638.8 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStats</span>

      From worker 2:       1649.8 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStats</span>

      From worker 3:        541.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → LinearAlgebraExt</span>

      From worker 4:        522.1 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → LinearAlgebraExt</span>

      From worker 2:        556.0 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → LinearAlgebraExt</span>

      From worker 5:       1723.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">OnlineStats</span>

      From worker 5:        580.7 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → LinearAlgebraExt</span>

      From worker 3:        663.7 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → SparseArraysExt</span>

      From worker 4:        643.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → SparseArraysExt</span>

      From worker 5:        664.1 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → SparseArraysExt</span>

      From worker 2:        689.8 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">KernelAbstractions → SparseArraysExt</span>

      From worker 3:       2536.3 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Graphs</span>

      From worker 5:       2537.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Graphs</span>

      From worker 5:        Dagger<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/Dagger/0a2f8_72NES.ji.pidfile)</span>

      From worker 2:       2564.3 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Graphs</span>

      From worker 2:        Dagger<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/Dagger/0a2f8_72NES.ji.pidfile)</span>

      From worker 4:       2595.6 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Graphs</span>

      From worker 4:        Dagger<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/Dagger/0a2f8_72NES.ji.pidfile)</span>

      From worker 3:    <span class="ansi-cyan-fg ansi-bold">Info</span> Given Dagger was explicitly requested, output will be shown live 

      From worker 3:    <span class="ansi-yellow-fg ansi-bold">┌ </span><span class="ansi-yellow-fg ansi-bold">Warning: </span>Precompile failed to clean up all tasks

      From worker 3:    <span class="ansi-yellow-fg ansi-bold">└ </span><span class="ansi-bright-black-fg">@ Dagger ~/.julia/packages/Dagger/0Eq6X/src/precompile.jl:21</span>

      From worker 3:      13626.6 ms<span class="ansi-green-fg">  ✓ </span>Dagger

      From worker 4:      13641.3 ms<span class="ansi-green-fg">  ✓ </span>Dagger

      From worker 4:        DistributionsExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/DistributionsExt/KnLSB_72NES.ji.pidfile)</span>

      From worker 5:      13762.0 ms<span class="ansi-green-fg">  ✓ </span>Dagger

      From worker 5:        DistributionsExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/DistributionsExt/KnLSB_72NES.ji.pidfile)</span>

      From worker 2:      13813.6 ms<span class="ansi-green-fg">  ✓ </span>Dagger

      From worker 2:        DistributionsExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/DistributionsExt/KnLSB_72NES.ji.pidfile)</span>

      From worker 3:       1157.8 ms<span class="ansi-green-fg">  ✓ </span>Dagger → DistributionsExt

      From worker 3:      11 dependencies successfully precompiled in 19 seconds. 74 already precompiled.

      From worker 3:      <span class="ansi-yellow-fg">2</span> dependencies had output during precompilation:<span class="ansi-yellow-fg">

      From worker 3:    ┌ </span>OnlineStats<span class="ansi-yellow-fg">

      From worker 3:    │  </span>WARNING: Constructor for type "Extrema" was extended in `OnlineStats` without explicit qualification or import.<span class="ansi-yellow-fg">

      From worker 3:    │  </span>  NOTE: Assumed "Extrema" refers to `OnlineStatsBase.Extrema`. This behavior is deprecated and may differ in future versions.`<span class="ansi-yellow-fg">

      From worker 3:    │  </span>  NOTE: This behavior may have differed in Julia versions prior to 1.12.<span class="ansi-yellow-fg">

      From worker 3:    │  </span>  Hint: If you intended to create a new generic function of the same name, use `function Extrema end`.<span class="ansi-yellow-fg">

      From worker 3:    │  </span>  Hint: To silence the warning, qualify `Extrema` as `OnlineStatsBase.Extrema` in the method signature or explicitly `import OnlineStatsBase: Extrema`.<span class="ansi-yellow-fg">

      From worker 3:    └  </span><span class="ansi-yellow-fg">

      From worker 3:    ┌ </span>Dagger<span class="ansi-yellow-fg">

      From worker 3:    │  </span>[Output was shown above]<span class="ansi-yellow-fg">

      From worker 3:    └  </span>

      From worker 2:       1030.8 ms<span class="ansi-green-fg">  ✓ </span>Dagger → DistributionsExt

      From worker 2:      11 dependencies successfully precompiled in 19 seconds. 74 already precompiled.

      From worker 5:       1209.3 ms<span class="ansi-green-fg">  ✓ </span>Dagger → DistributionsExt

      From worker 5:      11 dependencies successfully precompiled in 19 seconds. 74 already precompiled.

      From worker 4:       1390.2 ms<span class="ansi-green-fg">  ✓ </span>Dagger → DistributionsExt

      From worker 4:      11 dependencies successfully precompiled in 19 seconds. 74 already precompiled.

      From worker 3:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 2:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 2:        BangBangStaticArraysExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/BangBangStaticArraysExt/I8ZlX_72NES.ji.pidfile)</span>

      From worker 5:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 5:        BangBangStaticArraysExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/BangBangStaticArraysExt/I8ZlX_72NES.ji.pidfile)</span>

      From worker 4:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 4:        BangBangStaticArraysExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/BangBangStaticArraysExt/I8ZlX_72NES.ji.pidfile)</span>

      From worker 3:        292.4 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">BangBang → BangBangStaticArraysExt</span>

      From worker 4:          5.4 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">BangBang → BangBangStaticArraysExt</span>

      From worker 5:         90.4 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">BangBang → BangBangStaticArraysExt</span>

      From worker 2:        193.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">BangBang → BangBangStaticArraysExt</span>

      From worker 3:      1 dependency successfully precompiled in 0 seconds. 21 already precompiled.

      From worker 4:      1 dependency successfully precompiled in 0 seconds. 21 already precompiled.

      From worker 5:      1 dependency successfully precompiled in 0 seconds. 21 already precompiled.

      From worker 2:      1 dependency successfully precompiled in 0 seconds. 21 already precompiled.

      From worker 3:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 2:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 2:        TransducersOnlineStatsBaseExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/TransducersOnlineStatsBaseExt/UPWge_72NES.ji.pidfile)</span>

      From worker 4:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 4:        TransducersOnlineStatsBaseExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/TransducersOnlineStatsBaseExt/UPWge_72NES.ji.pidfile)</span>

      From worker 5:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 5:        TransducersOnlineStatsBaseExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41475, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/TransducersOnlineStatsBaseExt/UPWge_72NES.ji.pidfile)</span>

      From worker 3:        841.5 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Transducers → TransducersOnlineStatsBaseExt</span>

      From worker 3:      1 dependency successfully precompiled in 1 seconds. 62 already precompiled.

      From worker 5:        839.1 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Transducers → TransducersOnlineStatsBaseExt</span>

      From worker 5:      1 dependency successfully precompiled in 1 seconds. 62 already precompiled.

      From worker 2:        844.2 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Transducers → TransducersOnlineStatsBaseExt</span>

      From worker 2:      1 dependency successfully precompiled in 1 seconds. 62 already precompiled.

      From worker 4:        844.7 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Transducers → TransducersOnlineStatsBaseExt</span>

      From worker 4:      1 dependency successfully precompiled in 1 seconds. 62 already precompiled.

      From worker 2:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 5:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 5:        DistributionsTestExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41474, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/DistributionsTestExt/Mb8xE_72NES.ji.pidfile)</span>

      From worker 4:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 4:        DistributionsTestExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41474, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/DistributionsTestExt/Mb8xE_72NES.ji.pidfile)</span>

      From worker 3:    <span class="ansi-green-fg ansi-bold">Precompiling</span> packages...

      From worker 3:        DistributionsTestExt<span class="ansi-cyan-fg"> Being precompiled by another process (pid: 41474, pidfile: /Users/alecloudenback/.julia/compiled/v1.12/DistributionsTestExt/Mb8xE_72NES.ji.pidfile)</span>

      From worker 2:        575.9 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Distributions → DistributionsTestExt</span>

      From worker 2:      1 dependency successfully precompiled in 1 seconds. 51 already precompiled.

      From worker 5:        577.0 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Distributions → DistributionsTestExt</span>

      From worker 5:      1 dependency successfully precompiled in 1 seconds. 51 already precompiled.

      From worker 4:        577.5 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Distributions → DistributionsTestExt</span>

      From worker 4:      1 dependency successfully precompiled in 1 seconds. 51 already precompiled.

      From worker 3:        575.9 ms<span class="ansi-green-fg">  ✓ </span><span class="ansi-bright-black-fg">Distributions → DistributionsTestExt</span>

      From worker 3:      1 dependency successfully precompiled in 1 seconds. 51 already precompiled.

b: 4993.668859887446, c: 0.0
</pre>
</div>
</div>
</div>
</section>
</section>
<section id="choosing-a-parallelization-strategy" class="level2" data-number="11.9">
<h2 data-number="11.9" class="anchored" data-anchor-id="choosing-a-parallelization-strategy"><span class="header-section-number">11.9</span> Choosing a Parallelization Strategy</h2>
<p>There is no one-size-fits-all strategy to parallelization. Here are some general guides to thinking about what parallelization technique to try given the circumstances:</p>
<ul>
<li><p><strong>CPU-bound workloads with manageable memory demands:</strong> If your entire dataset fits comfortably in RAM and your operations are primarily arithmetic or straightforward loops, start by optimizing your single-threaded performance and consider <strong>vectorization (SIMD)</strong> for inner loops and <strong>multi-threading</strong> for parallelizable tasks. This approach leverages your CPU cores efficiently without introducing significant complexity.</p></li>
<li><p><strong>Large-scale linear algebra or highly data-parallel computations:</strong> If your problem involves large matrix operations, linear algebra routines, or embarrassingly parallel computations that can be batched over many independent elements, a <strong>GPU</strong> or other specialized accelerators may be beneficial. GPUs excel at uniform computations over large datasets and can provide substantial speedups, assuming data-transfer overhead and memory constraints are managed effectively. Note that standard linear algebra libraries are likely to already parallelize on the CPU without any explicit parallel code on your part.</p></li>
<li><p><strong>Distributing work across multiple machines or heterogeneous resources:</strong> If you need to scale beyond a single machine’s CPU and GPU capabilities, whether due to extremely large datasets, the need for concurrent access to geographically distributed resources, or leveraging specialized hardware, then consider <strong>distributed computing</strong>. Spreading tasks across multiple processes, servers, or clusters can scale performance horizontally. Just keep in mind the overhead of communication, potential data-partitioning strategies, and the complexity of managing a distributed environment.</p></li>
</ul>
<p>In practice, you may find that a combination of these approaches is ideal: start simple, measure performance, and iterate. By understanding your workload and hardware constraints, you can make informed decisions that balance complexity, cost, and the performance gains of parallel computing.</p>
</section>
<section id="references" class="level2" data-number="11.10">
<h2 data-number="11.10" class="anchored" data-anchor-id="references"><span class="header-section-number">11.10</span> References</h2>
<p>The following resources provide additional depth on parallel computing concepts and Julia-specific implementations:</p>
<ul>
<li><span class="citation" data-cites="rackauckas2020parallelism">Rackauckas (<a href="references.html#ref-rackauckas2020parallelism" role="doc-biblioref">2020</a>)</span> provides an excellent overview of parallelism types in the context of scientific computing</li>
<li><span class="citation" data-cites="juliadocs2024parallel">Julia Documentation (<a href="references.html#ref-juliadocs2024parallel" role="doc-biblioref">2024</a>)</span> is the official Julia documentation on parallel computing constructs</li>
<li><span class="citation" data-cites="enccs2023juliahpc">ENCCS (<a href="references.html#ref-enccs2023juliahpc" role="doc-biblioref">2023</a>)</span> offers hands-on tutorials for high-performance computing with Julia</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-enccs2023juliahpc" class="csl-entry" role="listitem">
ENCCS. 2023. <span>“Julia for High-Performance Computing.”</span> 2023. <a href="https://enccs.github.io/julia-for-hpc/">https://enccs.github.io/julia-for-hpc/</a>.
</div>
<div id="ref-juliadocs2024parallel" class="csl-entry" role="listitem">
Julia Documentation. 2024. <span>“Parallel Computing.”</span> 2024. <a href="https://docs.julialang.org/en/v1/manual/parallel-computing/">https://docs.julialang.org/en/v1/manual/parallel-computing/</a>.
</div>
<div id="ref-rackauckas2020parallelism" class="csl-entry" role="listitem">
Rackauckas, Chris. 2020. <span>“The Different Flavors of Parallelism.”</span> 2020. <a href="https://book.sciml.ai/notes/06-The_Different_Flavors_of_Parallelism/">https://book.sciml.ai/notes/06-The_Different_Flavors_of_Parallelism/</a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>Technically, it’s possible that the second task doesn’t write to the array first. This could happen if there’s enough tasks (from our program or others on the computer) that saturate the CPU during the first task’s <code>sleep</code> period such that the first task gets picked up again before the second one does.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>There are some chips which do not have access to the same memory in a multi-threading context, and are known as non-uniform memory access (NUMA). These architectures work more like those in <a href="#sec-multi-device" class="quarto-xref"><span>Section 11.7</span></a>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The <a href="https://github.com/JuliaGPU/KernelAbstractions.jl">KernelAbstractions.jl</a> library actually allows you to write generic kernels which then get compiled into different code depending on the backend you are using.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./performance-single.html" class="pagination-link" aria-label="Writing Performant Single-Threaded Code">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Writing Performant Single-Threaded Code</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./computational-thinking.html" class="pagination-link" aria-label="Interdisciplinary Concepts and Applications">
        <span class="nav-page-text">Interdisciplinary Concepts and Applications</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>